<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒ∞ngilizce A1 C√ºmle Kurma Programƒ±</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @keyframes highlight { 0% { transform: scale(1); } 20% { transform: scale(1.15) rotate(2deg); filter: brightness(1.8); } 100% { transform: scale(1); } }
    @keyframes bounce-error { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
    @keyframes emojiFly {
      0% { transform: scale(1.1) translateY(0); opacity: 1; }
      40% { transform: scale(2.5) translateY(-40px); opacity: 1; }
      100% { transform: scale(3) translateY(-100px); opacity: 0; }
    }
    @keyframes fall {
      0% { transform: translateY(-10vh) rotate(0deg) scale(1); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
    }

    .animate-highlight { animation: highlight 1.2s ease-in-out; z-index: 50; }
    .animate-bounce-error { animation: bounce-error 0.4s ease-in-out; }
    .animate-emoji-fly { animation: emojiFly 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    
    .confetti-particle {
      position: absolute;
      top: -20px;
      animation-name: fall;
      animation-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      animation-fill-mode: forwards;
    }

    .hide-scrollbar::-webkit-scrollbar { display: none; } 
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; } 
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; } 
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } 
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; } 
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
  </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
  <div id="root" class="h-screen w-full flex flex-col overflow-hidden relative"></div>

  <script>
    // --- VERƒ∞ TABANLARI ---
    const SEMANTIC_GROUPS = {
      food: ["pizza üçï", "an apple üçé", "bread üçû", "cake üç∞", "a sandwich ü•™", "dinner ü•ò", "soup üç≤", "eggs üç≥", "meat ü•©", "banana üçå", "pasta üçù", "a burger üçî", "a cookie üç™", "salad ü•ó", "chicken üçó", "cheese üßÄ", "fish üêü", "rice üçö"],
      liquid: ["water üíß", "milk ü•õ", "tea ‚òï", "coffee ‚òï", "juice üçπ", "coke ü•§", "lemonade üçã", "hot chocolate ‚òï", "orange juice üçä", "milkshake ü•§"],
      media: ["TV üì∫", "a movie üé¨", "a story üìñ", "a book üìö", "the board üìã", "photos üñºÔ∏è", "a video üìπ", "the lesson üéì", "music üé∂", "a song üéµ", "news üì∞", "cartoons üì∫", "a poem üìú", "homework üìñ"],
      activity: ["video games üïπÔ∏è", "the ball ‚öΩ", "a gift üéÅ", "a kite ü™Å", "a puzzle üß©", "chess ‚ôüÔ∏è", "football ‚öΩ", "tennis üéæ", "the piano üéπ", "the guitar üé∏", "a toy üß∏", "a bike üö≤", "cards üÉè", "basketball üèÄ", "drawing üé®"],
      place: ["to school üè´", "to the park üå≥", "home üè†", "to bed üõèÔ∏è", "the house üè†", "the room üßπ", "the garden üè°", "to the beach üèñÔ∏è", "the kitchen üç≥", "the city üåÜ", "in the forest üå≤", "at the zoo üêæ", "in the jungle üå¥"],
      sleep_place: ["in bed üõå", "on the sofa üõãÔ∏è", "in the room üßπ", "at home üè†", "in the garden üè°", "under the tree üå≥"],
      tool: ["a pen üñäÔ∏è", "a pencil ‚úèÔ∏è", "a laptop üíª", "scissors ‚úÇÔ∏è", "a map üó∫Ô∏è", "the table ü™ë", "the desk ü™ë", "the car üöó", "the window ü™ü", "the plate üçΩÔ∏è", "a phone üì±", "a bag üéí", "a computer üíª", "a cup ü•õ"]
    };

    const VERB_COMPATIBILITY = {
      "eat": ["food"], "drink": ["liquid"], "watch": ["media"], "read": ["media"], "play": ["activity"], "cook": ["food"],
      "clean": ["place", "tool", "sleep_place"], "wash": ["tool", "food"], "like": ["food", "liquid", "media", "activity", "tool", "place", "sleep_place"],
      "want": ["food", "liquid", "media", "activity", "tool", "place", "sleep_place"], "have": ["food", "liquid", "activity", "tool"],
      "buy": ["food", "liquid", "tool", "activity"], "see": ["food", "media", "activity", "place", "tool", "sleep_place"],
      "go": ["place"], "write": ["media", "tool"], "use": ["tool"], "open": ["media", "tool"], "need": ["food", "liquid", "tool", "activity"],
      "sleep": ["sleep_place", "place"], "run": ["place"], "jump": ["place"] 
    };

    const PAST_VERBS_MAP = {
      "eat üçΩÔ∏è": "ate üçΩÔ∏è", "drink ü•§": "drank ü•§", "like üòã": "liked üòã", "want ü•£": "wanted ü•£",
      "cook üç≥": "cooked üç≥", "sleep üò¥": "slept üò¥", "clean üßπ": "cleaned üßπ", "wash üßº": "washed üßº",
      "play üéÆ": "played üéÆ", "win üèÜ": "won üèÜ", "find üîé": "found üîé", "have üß∏": "had üß∏",
      "start üèÅ": "started üèÅ", "read üìñ": "read üìñ", "write üìù": "wrote üìù", "use üíª": "used üíª",
      "open üìñ": "opened üìñ", "need ‚úèÔ∏è": "needed ‚úèÔ∏è", "learn üß†": "learned üß†", "run üèÉ": "ran üèÉ",
      "jump ü¶ò": "jumped ü¶ò"
    };

    const GRAMMAR_GROUPS = {
      firstPerson: ["I üôã‚Äç‚ôÇÔ∏è"],
      thirdSingular: ["he üë®", "she üë©", "it üê∂", "my mother üë©", "my father üë®", "the cat üê±", "the teacher üë©‚Äçüè´", "the dog üê∂", "the bird üê¶", "the lion ü¶Å", "the monkey üêµ", "the elephant üêò"],
      pluralOrSecond: ["you ü´µ", "we üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "they üë•", "students üßë‚Äçüéì", "the boys üë¶", "the girls üëß", "your friend üë¶"]
    };

    const CATEGORIES = {
      home: {
        id: 'home', label: 'Ev', icon: 'home', color: '#f97316', requiredStars: 0,
        modals: ["can", "will", "must", "should"], auxiliaries: ["Do", "Does", "Can", "Is", "Are", "Am"], statusAux: ["am", "is", "are"],
        subjects: GRAMMAR_GROUPS.firstPerson.concat(GRAMMAR_GROUPS.thirdSingular).concat(["you ü´µ", "we üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "they üë•"]),
        verbs: ["eat üçΩÔ∏è", "drink ü•§", "like üòã", "want ü•£", "cook üç≥", "sleep üò¥", "clean üßπ", "wash üßº"],
        objects: [...SEMANTIC_GROUPS.food, ...SEMANTIC_GROUPS.liquid, ...SEMANTIC_GROUPS.sleep_place, ...SEMANTIC_GROUPS.tool],
        adjectives: ["hungry üòã", "thirsty ü•§", "full ü§∞", "happy üòä", "tired üò´", "ready üèÅ", "late ‚è∞", "sad üò¢", "brave ü¶Å", "strong üí™", "kind ‚ù§Ô∏è", "angry üò°", "sleepy ü•±", "excited ü§©", "silly ü§™", "cool üòé", "quiet ü§´", "loud üì¢", "lucky üçÄ", "scared üò®"]
      },
      games: {
        id: 'games', label: 'Oyun', icon: 'gamepad-2', color: '#a855f7', requiredStars: 0,
        modals: ["can", "will", "must", "could"], auxiliaries: ["Do", "Can", "Is", "Are"], statusAux: ["am", "is", "are"],
        subjects: ["you ü´µ", "we üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "they üë•", "your friend üë¶", "it ü§ñ", "the boys üë¶", "the girls üëß"],
        verbs: ["play üéÆ", "win üèÜ", "find üîé", "want üèóÔ∏è", "have üß∏", "start üèÅ", "sleep üò¥"],
        objects: [...SEMANTIC_GROUPS.activity, ...SEMANTIC_GROUPS.sleep_place],
        adjectives: ["fast ‚ö°", "slow üê¢", "exciting ü§©", "easy ‚úÖ", "hard ‚ùå", "fun üéà", "boring üò¥", "lucky üçÄ", "surprised üò≤"]
      },
      school: {
        id: 'school', label: 'Okul', icon: 'school', color: '#3b82f6', requiredStars: 0,
        auxiliaries: ["Do", "Does", "Can", "Is"], statusAux: ["am", "is", "are"],
        subjects: ["the teacher üë©‚Äçüè´", "students üßë‚Äçüéì", "I üôã‚Äç‚ôÇÔ∏è", "my friend üë¶", "she üë©", "he üë®"],
        verbs: ["read üìñ", "write üìù", "use üíª", "open üìñ", "need ‚úèÔ∏è", "learn üß†", "sleep üò¥"],
        objects: [...SEMANTIC_GROUPS.tool, ...SEMANTIC_GROUPS.media, ...SEMANTIC_GROUPS.sleep_place],
        adjectives: ["smart üß†", "busy ‚úçÔ∏è", "difficult üß©", "ready üèÅ", "late ‚è∞", "correct ‚úÖ", "silent ü§´", "perfect üíØ", "careful üßê", "polite ü§ù"]
      },
      animals: {
        id: 'animals', label: 'Hayvanlar', icon: 'cat', color: '#10b981', requiredStars: 10,
        modals: ["can", "will", "must"], auxiliaries: ["Do", "Does", "Can", "Is", "Are"], statusAux: ["is", "are"],
        subjects: ["the cat üê±", "the dog üê∂", "the bird üê¶", "the lion ü¶Å", "the monkey üêµ", "the elephant üêò", "they üë•", "it üê∂"],
        verbs: ["run üèÉ", "jump ü¶ò", "eat üçΩÔ∏è", "drink ü•§", "sleep üò¥", "play üéÆ"],
        objects: [...SEMANTIC_GROUPS.food, ...SEMANTIC_GROUPS.liquid, "in the forest üå≤", "at the zoo üêæ", "in the jungle üå¥", "to the park üå≥"],
        adjectives: ["fast ‚ö°", "slow üê¢", "cute ü•∫", "scary üò®", "hungry üòã", "thirsty ü•§", "sleepy ü•±", "wild üêæ", "funny üòÇ", "big üêò", "small üê≠"]
      }
    };

    const MODE_LABELS = {
      simple: 'Her zaman', negative: 'Olumsuz üö´', continuous: '≈ûimdiki',
      status: 'Durum', modal: 'Yetenek', question: 'Soru'
    };

    // --- UYGULAMA DURUMU (STATE) ---
    const state = {
      showLogin: true,
      userName: '',
      userGender: 'boy',
      nameInput: '',
      activeCategory: 'home',
      mode: 'simple',
      sentence: { aux: null, modal: null, subject: null, verb: null, object: null, adjective: null, ingVerb: null },
      isComplete: false,
      translation: '',
      isTranslating: false,
      isSpeaking: false,
      score: 0,
      funnyMistake: null,
      selectedPiece: null,
      leftDrawerOpen: false,
      rightDrawerOpen: false,
      isRecording: false,
      isEvaluating: false,
      pronunciationFeedback: ''
    };

    let mediaRecorder = null;
    let audioChunks = [];
    let currentDragSlot = null;

    // --- YARDIMCI FONKSƒ∞YONLAR ---
    const escapeHTML = str => String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    const clean = word => (!word || typeof word !== 'string') ? '' : word.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]/gu, '').trim();

    const getFullText = () => {
      const s = state.sentence;
      const parts = [];
      if (state.mode === 'question') parts.push(clean(s.aux), clean(s.subject), clean(s.verb || s.ingVerb), clean(s.object));
      else if (state.mode === 'negative') parts.push(clean(s.subject), clean(s.aux), clean(s.verb), clean(s.object));
      else {
        parts.push(clean(s.subject));
        if (s.aux) parts.push(clean(s.aux));
        if (s.modal) parts.push(clean(s.modal));
        if (s.verb || s.ingVerb) parts.push(clean(s.verb || s.ingVerb));
        if (s.object) parts.push(clean(s.object));
        if (s.adjective) parts.push(clean(s.adjective));
      }
      return parts.filter(Boolean).join(' ') + (state.mode === 'question' ? '?' : '.');
    };

    const getDynamicSubjects = () => {
      const userPiece = `${state.userName} ${state.userGender === 'boy' ? 'üë¶' : 'üëß'}`;
      return [userPiece, ...CATEGORIES[state.activeCategory].subjects];
    };

    const resetGame = () => {
      state.sentence = { aux: null, modal: null, subject: null, verb: null, object: null, adjective: null, ingVerb: null };
      state.isComplete = false;
      state.translation = '';
      state.isSpeaking = false;
      state.selectedPiece = null;
      state.funnyMistake = null;
      state.pronunciationFeedback = '';
      state.isEvaluating = false;
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
      state.isRecording = false;
    };

    const getMagicRule = () => {
      if (state.isComplete) return state.score % 10 === 0 && state.score > 0 ? "ƒ∞NANILMAZ! YENƒ∞ SEVƒ∞YEYE GE√áTƒ∞N! üöÄüê±" : "Harika! C√ºmlen artƒ±k hazƒ±r! üéâ";
      switch(state.mode) {
        case 'simple': return "Hediye Zamanƒ±: He/She/It fiile 's' takƒ±sƒ± verir! üéÅ";
        case 'negative': return "Hayƒ±r Zamanƒ±: 'Don't' ve 'Doesn't' ile 'yapmam' de! üôÖ‚Äç‚ôÄÔ∏è";
        case 'status': return "K√∂pr√º Kur: am, is, are ile birinin durumunu s√∂yle! üåâ";
        case 'continuous': return "Sihirli An: Fiile '-ing' ekle, ≈üu anƒ± anlat! üïí";
        case 'modal': return "S√ºper G√º√ß: 'Can' ile neler yapabileceƒüini g√∂ster! üí™";
        case 'question': return "Kaptanlar √ñne: Do/Is/Can c√ºmlenin ba≈üƒ±na ko≈üar! üë®‚Äç‚úàÔ∏è";
        default: return "S√ºr√ºkle veya kelimeye tƒ±klayƒ±p bo≈üluƒüa dokun! üëÜ";
      }
    };

    const getPureBaseVerb = (verbRaw) => {
      const cleaned = clean(verbRaw).toLowerCase();
      for (const [base, past] of Object.entries(PAST_VERBS_MAP)) {
        if (clean(past).toLowerCase() === cleaned) return clean(base).toLowerCase();
      }
      let baseV = cleaned.replace(/ing$/, '').replace(/s$/, '').replace(/es$/, '');
      if (baseV === "drinki") baseV = "drink";
      return baseV;
    };

    const checkSemanticOnly = (verbRaw, objRaw) => {
      if (!verbRaw || !objRaw) return true;
      const baseVerb = getPureBaseVerb(verbRaw);
      const obj = clean(objRaw).toLowerCase();
      const groups = VERB_COMPATIBILITY[baseVerb];
      if (groups) return groups.some(group => (SEMANTIC_GROUPS[group] || []).some(item => clean(item).toLowerCase() === obj));
      return true;
    };

    const validateHarmony = (type, value, current) => {
      const subj = type === 'subject' ? value : current.subject;
      const aux = type === 'aux' ? value : current.aux;

      if (subj && aux) {
        const cleanSubj = subj.toLowerCase();
        const cleanAux = aux.toLowerCase();
        const isI = cleanSubj.startsWith("i ");
        const isThirdSing = ["he ", "she ", "it ", "mother", "father", "cat", "teacher", "dog", "bird", "lion", "monkey", "elephant"].some(x => cleanSubj.includes(x));
        const isPlural = ["you ", "we ", "they ", "students", "boys", "girls", "friend"].some(x => cleanSubj.includes(x));

        if (cleanAux === "am" && !isI) return false;
        if (cleanAux === "is" && !isThirdSing) return false;
        if (cleanAux === "are" && !isPlural) return false;
        if (cleanAux === "do" && isThirdSing) return false;
        if (cleanAux === "does" && !isThirdSing) return false;
        if (cleanAux === "don't" && isThirdSing) return false;
        if (cleanAux === "doesn't" && (isI || isPlural)) return false;
      }
      const verbRaw = (type === 'verb' || type === 'ingVerb') ? value : (current.verb || current.ingVerb);
      const objRaw = type === 'object' ? value : current.object;
      if (verbRaw && objRaw) return checkSemanticOnly(verbRaw, objRaw);
      return true;
    };

    const getFunnyMistake = (verbRaw, objRaw, name) => {
      if (!verbRaw || !objRaw) return null;
      const baseVerb = getPureBaseVerb(verbRaw);
      const obj = clean(objRaw).toLowerCase();
      
      const isFood = SEMANTIC_GROUPS.food.some(item => clean(item).toLowerCase() === obj);
      const isLiquid = SEMANTIC_GROUPS.liquid.some(item => clean(item).toLowerCase() === obj);
      const isTool = SEMANTIC_GROUPS.tool.some(item => clean(item).toLowerCase() === obj);
      const isActivity = SEMANTIC_GROUPS.activity.some(item => clean(item).toLowerCase() === obj);

      if (baseVerb === 'drink' && isFood) return { emoji: "ü•§üçï", message: `Pizzayƒ± pipetle i√ßmek mi? √áok komiksin ${name}! üòÇ Yiyecekleri yemeliyiz.` };
      if (baseVerb === 'eat' && isLiquid) return { emoji: "üçΩÔ∏èüíß", message: `Suyu √ßiƒünemek biraz zor olabilir ${name}! üòÖ Sƒ±vƒ±larƒ± i√ßmeliyiz.` };
      if (baseVerb === 'sleep' && (isFood || isLiquid)) return { emoji: "üò¥üçî", message: `Yemeƒüin √ºst√ºnde uyumak mƒ±? üõå Yatak daha rahat bence ${name}!` };
      if (baseVerb === 'read' && (isFood || isLiquid)) return { emoji: "üìñüçï", message: `Acaba yemeƒüin √ºzerinde ne yazƒ±yor? √áok ≈üakacƒ±sƒ±n ${name}! ü§°` };
      if (baseVerb === 'play' && (isFood || isLiquid)) return { emoji: "‚öΩüçî", message: `Yiyeceklerle oynamak yerine onlarƒ± yesek mi ${name}? üòã` };
      if ((baseVerb === 'run' || baseVerb === 'jump') && (isFood || isLiquid)) return { emoji: "üèÉüçî", message: `Yemeƒüin √ºst√ºnde zƒ±plamak mƒ±? Annen kƒ±zmasƒ±n ${name}! üôà` };
      if (baseVerb === 'drink' && isActivity) return { emoji: "ü•§‚öΩ", message: `Oyun oynanƒ±r ama i√ßilmez ${name}! Sadece sƒ±vƒ±larƒ± i√ßebiliriz. üßÉ` };
      if (baseVerb === 'eat' && isTool) return { emoji: "üçΩÔ∏èüíª", message: `Bilgisayarƒ± veya kalemi yersek di≈ülerimiz kƒ±rƒ±labilir ${name}! ü¶∑` };
      
      return { emoji: "ü§°", message: `Burasƒ± biraz tuhaf oldu sanki ${name}! Ba≈üka bir kelime deneyelim mi? ü™Ñ` };
    };

    const applyGrammarRules = () => {
      if (!state.sentence.subject) return;
      if (state.mode === 'simple' && state.sentence.verb) {
        const cleanSubj = state.sentence.subject.toLowerCase();
        const isThirdSing = ["he ", "she ", "it ", "mother", "father", "cat", "teacher", "dog", "bird", "lion", "monkey", "elephant"].some(x => cleanSubj.includes(x));
        const parts = state.sentence.verb.split(' ');
        const base = parts[0].replace(/s$/, '').replace(/es$/, '');
        const emoji = parts.slice(1).join(' ');
        let target = state.sentence.verb;
        if (isThirdSing) {
          const s = (base.endsWith('sh') || base.endsWith('ch') || base.endsWith('ss')) ? 'es' : 's';
          target = `${base}${s} ${emoji}`;
        } else { target = `${base} ${emoji}`; }
        
        if (state.sentence.verb !== target) {
          state.sentence.verb = target;
          const slot = document.querySelector(`.puzzle-slot[data-type="verb"]`);
          if (slot) {
            slot.classList.add('animate-highlight');
            setTimeout(() => slot.classList.remove('animate-highlight'), 1200);
          }
        }
      }
    };

    const processPlacement = (targetType, sourceData) => {
      const isVerbMatch = (targetType === 'verb' && (sourceData.type === 'verb' || sourceData.type === 'ingVerb'));
      const isAuxMatch = (targetType === 'aux' && (sourceData.type === 'aux' || sourceData.type === 'modal'));
      
      if (sourceData.type === targetType || isVerbMatch || isAuxMatch) {
        const actualType = isVerbMatch ? sourceData.type : (isAuxMatch ? sourceData.type : targetType);
        
        if (!validateHarmony(actualType, sourceData.value, state.sentence)) {
          if (['verb', 'ingVerb', 'object'].includes(actualType)) {
            const tempSentence = { ...state.sentence, [actualType]: sourceData.value };
            const vRaw = tempSentence.verb || tempSentence.ingVerb;
            const oRaw = tempSentence.object;
            if (vRaw && oRaw && !checkSemanticOnly(vRaw, oRaw)) {
              const mistake = getFunnyMistake(vRaw, oRaw, state.userName);
              if (mistake) {
                state.funnyMistake = mistake;
                updateUI();
                setTimeout(() => { state.funnyMistake = null; updateUI(); }, 5000); 
              }
            }
          }
          const slotEl = document.querySelector(`.puzzle-slot[data-type="${targetType}"]`);
          if (slotEl) {
            slotEl.classList.add('animate-bounce-error');
            const path = slotEl.querySelector('path');
            if(path) { path.setAttribute('stroke', '#b91c1c'); path.setAttribute('fill', '#ef4444'); }
            setTimeout(() => {
              slotEl.classList.remove('animate-bounce-error');
              updateUI();
            }, 800);
          }
          return;
        }

        state.sentence[actualType] = sourceData.value;
        applyGrammarRules();
        
        let isFinished = false;
        const sen = state.sentence;
        const m = state.mode;
        if (m === 'question') isFinished = (sen.aux && sen.subject && (sen.verb || sen.ingVerb) && sen.object);
        else if (m === 'modal' || m === 'negative') isFinished = (sen.subject && (sen.modal || sen.aux) && sen.verb && sen.object);
        else if (m === 'status') isFinished = (sen.subject && sen.aux && sen.adjective);
        else if (m === 'continuous') isFinished = (sen.subject && sen.aux && sen.ingVerb && sen.object);
        else isFinished = (sen.subject && sen.verb && sen.object);
        
        if (isFinished && !state.isComplete) {
          state.isComplete = true;
          state.leftDrawerOpen = false;
          state.rightDrawerOpen = false;
          state.selectedPiece = null;
          state.score += 1;
          
          if (state.score % 10 === 0 && state.score > 0) triggerConfetti(true);
          else triggerConfetti(false);

          const fullText = getFullText();
          updateUI(); // Immediately show complete state
          fetchTranslation(fullText);
          fetchAndPlayTTS(fullText);
        } else {
          state.selectedPiece = null;
          state.leftDrawerOpen = false;
          state.rightDrawerOpen = false;
          updateUI();
        }
      } else {
        state.selectedPiece = null; 
        updateUI();
      }
    };

    // --- API FONKSƒ∞YONLARI ---
    const playAudioFromPCM = (base64Data, sampleRate = 24000) => {
      const binaryString = window.atob(base64Data);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

      const wavHeader = new ArrayBuffer(44);
      const view = new DataView(wavHeader);
      view.setUint32(0, 0x46464952, true); 
      view.setUint32(4, 36 + len, true);
      view.setUint32(8, 0x45564157, true); 
      view.setUint32(12, 0x20746d66, true);
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      view.setUint32(36, 0x61746164, true);
      view.setUint32(40, len, true);
      const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
    };

    const blobToBase64 = blob => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
    });

    const apiKey = ""; 

    const fetchTranslation = async (text) => {
      state.isTranslating = true; updateUI();
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text }] }], systemInstruction: { parts: [{ text: "Sen bir ƒ∞ngilizce √∂ƒüretmenisin. Verilen ƒ∞ngilizce c√ºmleyi, kelime dizili≈üine ve anlamƒ±na m√ºmk√ºn olduƒüunca sadƒ±k kalarak (birebir) T√ºrk√ßeye √ßevir. √áeviri 8 ya≈üƒ±ndaki bir √ßocuƒüun anlayacaƒüƒ± netlikte ve sevimli olmalƒ±. Sadece √ßeviriyi d√∂nd√ºr." }] } })
        });
        const result = await response.json();
        state.translation = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "M√ºthi≈üsin! üéâ";
      } catch (err) { state.translation = "C√ºmlen harika oldu! üòä"; }
      state.isTranslating = false; updateUI();
    };

    const fetchAndPlayTTS = async (text) => {
      state.isSpeaking = true; updateUI();
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Say slowly, clearly and naturally in a sweet girl's voice. IMPORTANT: The word "${state.userName}" is a Turkish name. Please pronounce it with Turkish phonics. Sentence: ${text}` }] }],
            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
          })
        });
        const result = await response.json();
        const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        if (audioData) playAudioFromPCM(audioData);
      } catch (err) { console.error(err); }
      state.isSpeaking = false; updateUI();
    };

    const evaluatePronunciation = async (base64Audio, mimeType) => {
      state.isEvaluating = true; updateUI();
      try {
        const targetSentence = getFullText();
        const prompt = `Sen ƒ∞ngilizce √∂ƒürenen 8 ya≈üƒ±ndaki A≈ükƒ±m'ƒ±n sevgi dolu dijital √∂ƒüretmenisin. G√∂revi ≈üu c√ºmleyi okumaktƒ±: "${targetSentence}". Ekli ses kaydƒ±nda A≈ükƒ±m'ƒ±n okuyu≈üu var. Ses kaydƒ±nƒ± dinle ve telaffuzunu deƒüerlendir. Eƒüer doƒüruya yakƒ±n ve √ßabalamƒ±≈üsa (ufak tefek √ßocuksu hatalarƒ± g√∂rmezden gel), √ßok motive edici, co≈ükulu ve ismini ("${state.userName}") kullanarak T√ºrk√ße bir tebrik mesajƒ± yaz (√ñrn: "Harika telaffuz ettin A≈ükƒ±m! Yƒ±ldƒ±zlar senin i√ßin! üåü"). Eƒüer hi√ß anla≈üƒ±lmƒ±yor, sadece bo≈üluk veya alakasƒ±z bir ses varsa, onu kƒ±rmadan "Biraz daha y√ºksek sesle bir kez daha denemek ister misin ${state.userName}? Sana g√ºveniyorum!" gibi bir d√∂n√º≈ü yap. Sadece bu 1-2 c√ºmlelik tatlƒ± geri bildirimi ver. Asla metin dƒ±≈üƒ±nda bir ≈üey ekleme.`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: mimeType || "audio/webm", data: base64Audio } } ] }] })
        });
        const result = await response.json();
        state.pronunciationFeedback = result.candidates?.[0]?.content?.parts?.[0]?.text || `Harika okudun ${state.userName}! üåü M√ºkemmel telaffuz!`;
      } catch (err) { state.pronunciationFeedback = `Sesini tam alamadƒ±m ama eminim harika okumu≈üsundur ${state.userName}! üé§`; }
      state.isEvaluating = false; updateUI();
    };

    const toggleRecording = async () => {
      if (state.isRecording) {
        if (mediaRecorder) mediaRecorder.stop();
        state.isRecording = false; updateUI();
      } else {
        state.pronunciationFeedback = ''; updateUI();
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
          mediaRecorder.onstop = async () => {
            const mimeType = mediaRecorder.mimeType || 'audio/webm';
            const audioBlob = new Blob(audioChunks, { type: mimeType });
            stream.getTracks().forEach(t => t.stop());
            const base64 = await blobToBase64(audioBlob);
            evaluatePronunciation(base64, mimeType);
          };
          mediaRecorder.start();
          state.isRecording = true; updateUI();
        } catch (err) {
          state.pronunciationFeedback = `Mikrofonuna ula≈üamadƒ±m ${state.userName}! Cihaz ayarlarƒ±ndan izin vermen gerekebilir. üéôÔ∏è`;
          updateUI();
        }
      }
    };

    // --- HTML RENDER FONKSƒ∞YONLARI ---

    function triggerConfetti(isLevelUp) {
      const colors = ['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#a855f7', '#ec4899', '#f97316', '#fbbf24'];
      const count = isLevelUp ? 200 : 60; 
      const container = document.createElement('div');
      container.className = 'fixed inset-0 pointer-events-none z-[100] overflow-hidden';
      
      for(let i=0; i<count; i++) {
        const p = document.createElement('div');
        const size = Math.random() * (isLevelUp ? 12 : 8) + 6 + 'px';
        p.className = 'confetti-particle';
        p.style.left = Math.random() * 100 + 'vw';
        p.style.width = size; p.style.height = size;
        p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        p.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        p.style.animationDuration = Math.random() * 2.5 + 2 + 's';
        p.style.animationDelay = Math.random() * 0.5 + 's';
        container.appendChild(p);
      }
      document.body.appendChild(container);
      setTimeout(() => { if (document.body.contains(container)) document.body.removeChild(container); }, 5000);
    }

    const renderPuzzlePiece = ({ type, color, content, isSelected, isSelectedPiece, isSlot, shape, isInvalid, isComplete }) => {
      const isPlacedInSlot = isSlot && content;
      const currentWidth = isPlacedInSlot ? 234 : 180;
      const currentHeight = isPlacedInSlot ? 85 : 65;

      const paths = {
        SUBJ_START: `M0,10 Q0,0 10,0 L170,0 L170,20 L195,40 L170,60 L170,80 L10,80 Q0,80 0,70 Z`,
        SUBJ_MID: `M30,0 L170,0 L170,20 L195,40 L170,60 L170,80 L30,80 L30,60 L55,40 L30,20 L30,0 Z`,
        VERB_SIMPLE: `M30,0 L170,0 L170,25 L190,25 L190,55 L170,55 L170,80 L30,80 L30,60 L55,40 L30,20 L30,0 Z`,
        BE_MODAL: `M30,0 L170,0 L170,20 L195,40 L170,60 L170,80 L30,80 L30,60 L55,40 L30,20 L30,0 Z`,
        AUX_START: `M0,10 Q0,0 10,0 L170,0 L170,20 L195,40 L170,60 L170,80 L10,80 Q0,80 0,70 Z`,
        VERB_ING: `M30,0 L170,0 L170,25 L190,25 L190,55 L170,55 L170,80 L30,80 L30,55 L50,55 L50,25 L30,25 L30,0 Z`,
        ADJECTIVE: `M30,0 L190,0 Q200,0 200,10 L200,70 Q200,80 190,80 L30,80 L30,65 L45,65 L45,50 L30,50 L30,30 L45,30 L45,15 L30,15 L30,0 Z`,
        VERB_BASE: `M30,0 L170,0 L170,25 L190,25 L190,55 L170,55 L170,80 L30,80 L30,65 L45,65 L45,50 L30,50 L30,30 L45,30 L45,15 L30,15 L30,0 Z`,
        OBJ_END: `M30,0 L190,0 Q200,0 200,10 L200,70 Q200,80 190,80 L30,80 L30,55 L50,55 L50,25 L30,25 L30,0 Z`
      };

      let formattedContent = '';
      if (content) {
        const text = content.replace('_adj', '').replace('_v', '');
        const parts = text.split(/(\p{Emoji})/u);
        formattedContent = parts.map(part => {
          if (/\p{Emoji}/u.test(part)) {
            // Emoji Fly animation is removed as per last instruction, back to original scale
            const classStr = isPlacedInSlot 
               ? `inline-block text-3xl mx-1.5 transform scale-110` 
               : `inline-block text-2xl mx-1 transform scale-150`;
            return `<span class="${classStr}">${part}</span>`;
          }
          return `<span>${part}</span>`;
        }).join('');
      }

      const pieceColor = isInvalid ? '#ef4444' : (content ? color : (isSelectedPiece ? '#e2e8f0' : '#f8fafc'));
      const strokeColor = isSelectedPiece ? '#eab308' : (isInvalid ? '#b91c1c' : (content ? 'rgba(0,0,0,0.2)' : '#cbd5e1'));

      const dragAttr = (!!content && !isSlot) ? 'draggable="true"' : '';
      const dataAttrs = `data-type="${type}" ${content ? `data-value="${escapeHTML(content)}"` : ''}`;
      const actionAttr = isSlot ? `data-action="slot-click"` : `data-action="piece-click"`;

      let classes = `puzzle-piece relative transition-all duration-500 ease-out transform flex flex-col items-center justify-center`;
      if (isSlot) classes += ` puzzle-slot cursor-pointer`;
      else classes += ` cursor-grab active:cursor-grabbing`;

      if (isSelected && !isSlot) classes += ` opacity-40 grayscale-[0.5]`;
      else if (!isSlot) classes += ` hover:scale-102`;

      if (isSelectedPiece) classes += ` scale-105 drop-shadow-2xl z-20`;

      return `
        <div class="${classes}" style="width: ${currentWidth}px; height: ${currentHeight}px" ${dragAttr} ${dataAttrs} ${actionAttr}>
          <svg viewBox="0 0 200 80" preserveAspectRatio="none" class="w-full h-full drop-shadow-md transition-all absolute inset-0 ${isSelectedPiece ? 'brightness-105' : ''}">
            <path d="${paths[shape] || paths.SUBJ_START}" fill="${pieceColor}" stroke="${strokeColor}" stroke-width="${isInvalid || isSelectedPiece ? "4" : "2"}" stroke-dasharray="${!content ? "6,4" : "0"}"></path>
          </svg>
          <div class="absolute inset-0 flex flex-col items-center justify-center p-2 pointer-events-none overflow-hidden text-center z-10">
            <span class="font-black tracking-tight transition-all flex items-center justify-center flex-wrap ${content ? 'text-white' : 'text-slate-400 uppercase tracking-widest opacity-60'} ${isPlacedInSlot ? 'text-sm md:text-lg lg:text-xl px-5' : 'text-[10px] md:text-[11px] lg:text-xs px-3'}">
              ${content ? formattedContent : type}
            </span>
          </div>
        </div>
      `;
    };

    const renderLogin = () => `
      <div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center p-4">
        <div class="bg-white p-8 md:p-10 rounded-[3rem] shadow-2xl max-w-md w-full text-center transform transition-all scale-100">
          <div class="relative inline-block mb-6">
             <div class="w-24 h-24 rounded-full flex items-center justify-center transition-all bg-indigo-100 text-indigo-500">
                <i data-lucide="user-circle" class="w-16 h-16"></i>
             </div>
             <div class="absolute -bottom-2 -right-2 bg-white rounded-full p-1 shadow-md text-amber-400 fill-amber-400"><i data-lucide="star" class="w-6 h-6"></i></div>
          </div>
          <h1 class="text-2xl md:text-3xl font-black text-slate-800 mb-2 italic">Ho≈ü Geldin!</h1>
          <p class="text-slate-500 font-bold mb-6 text-base md:text-lg">ƒ∞ngilizce oynamaya hazƒ±r mƒ±sƒ±n?</p>
          <input type="text" id="nameInput" placeholder="Adƒ±nƒ± buraya yaz..." value="${escapeHTML(state.nameInput)}" class="w-full bg-slate-100 border-2 border-slate-200 px-6 py-4 rounded-3xl font-black text-lg focus:outline-none focus:border-indigo-400 transition-all text-center mb-6" />
          <button data-action="start-game" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-black text-xl py-4 rounded-3xl shadow-lg flex items-center justify-center gap-3 transition-transform active:scale-95">
            <i data-lucide="play-circle" class="w-7 h-7"></i> BA≈ûLA
          </button>
        </div>
      </div>
    `;

    const renderHeader = () => `
      <header class="bg-white border-b border-slate-200 p-2 md:px-4 md:py-2 flex flex-col md:flex-row items-center justify-between shadow-sm z-20 shrink-0 gap-2 md:gap-0">
        <div class="flex items-center gap-2 md:gap-3 w-full md:w-auto justify-between md:justify-start">
          <div class="flex items-center gap-2">
            <div class="px-2 py-1.5 md:px-3 rounded-xl border flex items-center gap-2 bg-indigo-50 border-indigo-100">
              <i data-lucide="user-circle" class="text-indigo-500 w-4 h-4 md:w-5 md:h-5"></i>
              <span class="font-black text-slate-700 text-xs md:text-sm whitespace-nowrap">${escapeHTML(state.userName)}</span>
            </div>
            <div class="flex items-center gap-1 px-2 py-1.5 md:px-3 rounded-xl border shadow-sm transition-all duration-300 ${state.score >= 10 ? 'bg-indigo-50 border-indigo-300 scale-105' : 'bg-amber-50 border-amber-200'}" title="Kazanƒ±lan Yƒ±ldƒ±zlar">
              <i data-lucide="star" class="${state.score >= 10 ? 'text-indigo-500 fill-indigo-400' : 'text-amber-500 fill-amber-400'} w-4 h-4"></i>
              <span class="font-black text-xs md:text-sm ${state.score >= 10 ? 'text-indigo-700' : 'text-amber-700'}">${state.score}</span>
            </div>
          </div>
          
          <div class="flex gap-1 bg-slate-50 p-1 rounded-xl border border-slate-200 overflow-x-auto hide-scrollbar">
            ${Object.values(CATEGORIES).map(cat => {
              const isLocked = cat.requiredStars > 0 && state.score < cat.requiredStars;
              const btnClass = isLocked ? 'opacity-40 cursor-not-allowed bg-slate-200 text-slate-500' : (state.activeCategory === cat.id ? 'text-white shadow-sm' : 'text-slate-500 hover:bg-white');
              const btnStyle = state.activeCategory === cat.id ? `background-color: ${cat.color}` : 'background-color: transparent';
              return `
                <button data-action="${isLocked ? '' : 'set-category'}" data-payload="${cat.id}" style="${btnStyle}" class="flex items-center gap-1 px-2 md:px-3 py-1 rounded-lg font-bold text-[10px] md:text-xs transition-all whitespace-nowrap ${btnClass}">
                  <i data-lucide="${isLocked ? 'lock' : cat.icon}" class="w-3.5 h-3.5"></i> ${cat.label}
                </button>`;
            }).join('')}
          </div>
        </div>
        <div class="flex gap-1 bg-slate-50 p-1 rounded-xl border border-slate-200 w-full md:w-auto overflow-x-auto hide-scrollbar justify-center">
          ${Object.keys(MODE_LABELS).map(m => `
            <button data-action="set-mode" data-payload="${m}" class="px-2 py-1 md:px-3 rounded-lg font-black text-[9px] md:text-[10px] uppercase transition-all whitespace-nowrap ${state.mode === m ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-400 hover:bg-white'}">
              ${MODE_LABELS[m]}
            </button>
          `).join('')}
        </div>
      </header>
    `;

    const renderAssemblyArea = () => {
      let html = '';
      const s = state.sentence;
      const m = state.mode;
      const sp = state.selectedPiece;
      
      const renderPz = (type, color, content, shape) => renderPuzzlePiece({
        type, color, content, shape, isSlot: true, isComplete: state.isComplete,
        isSelectedPiece: sp?.type === type && sp?.value === content
      });

      if (m === 'question') {
        html += renderPz('aux', '#6366f1', s.aux, 'AUX_START');
        html += renderPz('subject', '#3b82f6', s.subject, 'SUBJ_MID');
        html += renderPz('verb', '#ef4444', s.verb || s.ingVerb, 'VERB_SIMPLE');
        html += renderPz('object', '#22c55e', s.object, 'OBJ_END');
        html += `<span class="text-6xl font-black text-indigo-600 ml-10">?</span>`;
      } else if (m === 'negative') {
        html += renderPz('subject', '#3b82f6', s.subject, 'SUBJ_START');
        html += renderPz('aux', '#ec4899', s.aux, 'BE_MODAL');
        html += renderPz('verb', '#f97316', s.verb, 'VERB_BASE');
        html += renderPz('object', '#22c55e', s.object, 'OBJ_END');
      } else if (m === 'modal') {
        html += renderPz('subject', '#3b82f6', s.subject, 'SUBJ_START');
        html += renderPz('modal', '#f59e0b', s.modal, 'BE_MODAL');
        html += renderPz('verb', '#ef4444', s.verb, 'VERB_BASE');
        html += renderPz('object', '#22c55e', s.object, 'OBJ_END');
      } else {
        html += renderPz('subject', '#3b82f6', s.subject, 'SUBJ_START');
        if (m === 'status' || m === 'continuous') html += renderPz('aux', '#0d9488', s.aux, 'BE_MODAL');
        if (m === 'status') html += renderPz('adjective', '#8b5cf6', s.adjective, 'ADJECTIVE');
        else {
          html += renderPz('verb', '#ef4444', s.verb || s.ingVerb, m === 'continuous' ? 'VERB_ING' : 'VERB_SIMPLE');
          html += renderPz('object', '#22c55e', s.object, 'OBJ_END');
        }
      }
      return html;
    };

    const renderApp = () => {
      const cData = CATEGORIES[state.activeCategory];
      const sp = state.selectedPiece;

      return `
        ${state.funnyMistake ? `
          <div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm transition-all" data-action="close-funny-mistake">
            <div class="bg-white rounded-[3rem] p-6 md:p-8 max-w-sm w-full shadow-2xl flex flex-col items-center text-center border-8 border-amber-300 transform transition-all animate-bounce" onclick="event.stopPropagation()">
              <div class="text-6xl md:text-7xl mb-4">${state.funnyMistake.emoji}</div>
              <h3 class="text-2xl md:text-3xl font-black text-amber-500 mb-2">Hoppala! ü§°</h3>
              <p class="text-slate-700 font-bold text-base md:text-lg leading-snug">${state.funnyMistake.message}</p>
              <button data-action="close-funny-mistake" class="mt-6 bg-amber-400 hover:bg-amber-500 text-white font-black px-6 py-3 rounded-2xl active:scale-95 transition-transform">Tekrar Dene!</button>
            </div>
          </div>
        ` : ''}

        ${(state.leftDrawerOpen || state.rightDrawerOpen) ? `<div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-30 md:hidden" data-action="close-drawers"></div>` : ''}

        <div class="absolute left-0 top-[40%] -translate-y-1/2 z-20 md:hidden">
          <button data-action="toggle-left-drawer" class="bg-blue-600/90 text-white p-2 py-6 rounded-r-2xl shadow-lg flex flex-col items-center gap-2 backdrop-blur-sm active:scale-95 transition-transform">
             <i data-lucide="arrow-right-circle" class="w-5 h-5"></i>
             <span class="font-black text-xs" style="writing-mode: vertical-rl;">Kƒ∞M?</span>
          </button>
        </div>
        <div class="absolute right-0 top-[40%] -translate-y-1/2 z-20 md:hidden">
          <button data-action="toggle-right-drawer" class="bg-green-600/90 text-white p-2 py-6 rounded-l-2xl shadow-lg flex flex-col items-center gap-2 backdrop-blur-sm active:scale-95 transition-transform">
             <i data-lucide="arrow-left-circle" class="w-5 h-5"></i>
             <span class="font-black text-xs" style="writing-mode: vertical-rl;">NEYƒ∞?</span>
          </button>
        </div>

        ${renderHeader()}

        <div class="flex-1 flex overflow-hidden">
          <!-- SOL MEN√ú -->
          <aside class="fixed md:relative inset-y-0 left-0 w-64 md:w-72 bg-white border-r border-slate-200 flex flex-col shadow-2xl md:shadow-inner z-40 transform transition-transform duration-300 md:translate-x-0 shrink-0 ${state.leftDrawerOpen ? 'translate-x-0' : '-translate-x-full'}">
            <div class="bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest text-center py-3 italic shadow-sm flex items-center justify-center relative">
              Kƒ∞M? (SUBJECT)
              <button class="md:hidden absolute right-3 text-blue-200 hover:text-white" data-action="close-drawers"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 flex flex-wrap content-start gap-2 custom-scrollbar">
              ${getDynamicSubjects().map(s => renderPuzzlePiece({ type: 'subject', color: '#3b82f6', content: s, isSelected: state.sentence.subject === s, isSelectedPiece: sp?.type === 'subject' && sp?.value === s, shape: state.mode === 'question' ? 'SUBJ_MID' : 'SUBJ_START' })).join('')}
            </div>
          </aside>

          <!-- ORTA ALAN -->
          <main class="flex-1 flex flex-col bg-slate-50 relative min-w-0">
            <div class="flex-1 flex flex-col items-center justify-start pt-2 md:pt-4 p-2 md:p-4 overflow-y-auto w-full">
              
              <!-- Sƒ∞Hƒ∞RLƒ∞ KURAL -->
              <div class="mb-2 md:mb-4 w-full max-w-xl transition-all duration-500 px-4">
                  <div class="p-2 md:p-3 rounded-2xl border-2 flex items-center justify-center gap-2 md:gap-3 shadow-md transition-all ${state.isComplete ? 'bg-amber-100 border-amber-300 scale-105' : 'bg-indigo-50 border-indigo-100'}">
                    ${state.score % 10 === 0 && state.score > 0 && state.isComplete ? '<i data-lucide="party-popper" class="w-5 h-5 text-indigo-500 animate-bounce"></i>' : `<i data-lucide="sparkles" class="w-4 h-4 md:w-5 md:h-5 ${state.isComplete ? 'text-amber-500 animate-pulse' : 'text-indigo-400'}"></i>`}
                    <p class="text-[10px] md:text-[12px] font-black uppercase tracking-wide text-center ${state.score % 10 === 0 && state.score > 0 && state.isComplete ? 'text-indigo-700' : (state.isComplete ? 'text-amber-800' : 'text-indigo-700')}">
                      ${getMagicRule()}
                    </p>
                  </div>
              </div>

              <!-- MONTAJ ALANI -->
              <div class="bg-white rounded-[2rem] md:rounded-[3rem] w-full max-w-5xl p-2 md:p-6 shadow-xl border-2 border-slate-200 flex flex-col items-center justify-center min-h-[140px] md:min-h-[220px] relative overflow-hidden transition-all z-10">
                <div class="flex flex-row items-center justify-center transition-all duration-300 transform scale-[0.55] sm:scale-[0.8] md:scale-90 lg:scale-100 origin-center -space-x-[55px] w-full">
                  ${renderAssemblyArea()}
                </div>
              </div>

              <div class="mt-4 md:mt-4 w-full flex flex-col items-center justify-center gap-2 text-center z-10 px-2 max-w-2xl mx-auto">
                ${state.isComplete ? `
                  <div class="p-3 md:p-4 rounded-3xl border-2 w-full animate-in slide-in-from-bottom duration-500 shadow-sm flex items-center justify-between gap-2 ${state.score % 10 === 0 && state.score > 0 ? 'bg-indigo-100 border-indigo-300' : 'bg-green-100 border-green-200'}">
                    <div class="flex-1">
                      <div class="bg-white/60 p-2 rounded-xl border border-green-200 flex items-start gap-2 shadow-inner">
                        <i data-lucide="languages" class="w-4 h-4 md:w-5 md:h-5 text-indigo-600 shrink-0 mt-0.5"></i>
                        <p class="text-xs md:text-sm font-black text-slate-800 italic leading-tight text-left">
                           ${state.isTranslating ? '<span class="flex items-center gap-2 text-slate-400"><i data-lucide="loader-2" class="w-3 h-3 md:w-4 md:h-4 animate-spin"></i> Bakƒ±yorum...</span>' : state.translation}
                        </p>
                      </div>
                    </div>
                    <div class="p-3 rounded-full transition-all shrink-0 ${state.isSpeaking ? 'bg-amber-100 animate-pulse scale-110' : 'bg-white/50'}">
                      <i data-lucide="volume-2" class="${state.isSpeaking ? 'text-amber-600' : 'text-slate-400'} w-5 h-5"></i>
                    </div>
                  </div>
                  
                  <div class="w-full bg-blue-50 border-2 border-blue-200 rounded-3xl p-3 shadow-sm flex flex-col items-center gap-2 animate-in slide-in-from-bottom duration-700 delay-300 fill-mode-both">
                    <div class="flex items-center justify-center gap-3 w-full">
                      <div class="flex flex-col items-end text-right">
                        <span class="font-black text-blue-700 text-sm md:text-base">Konu≈üma Sƒ±rasƒ± Sende! üé§</span>
                        <span class="text-[10px] md:text-xs text-blue-500 font-bold">
                          ${state.isRecording ? "Dinliyorum, bitirince tekrar dokun..." : "Mikrofona dokun ve c√ºmleyi oku"}
                        </span>
                      </div>
                      <button data-action="toggle-recording" class="p-3 md:p-4 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center ${state.isRecording ? 'bg-red-500 text-white animate-pulse scale-110 shadow-red-200' : 'bg-blue-500 text-white hover:bg-blue-600 hover:scale-105'}">
                        <i data-lucide="mic" class="w-6 h-6"></i>
                      </button>
                    </div>
                    ${state.isEvaluating ? `
                      <div class="flex items-center justify-center gap-2 text-indigo-600 font-bold text-xs md:text-sm animate-pulse w-full bg-white/60 p-2 rounded-xl">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Yapay Zeka Sesini ƒ∞nceliyor...
                      </div>
                    ` : ''}
                    ${state.pronunciationFeedback && !state.isEvaluating ? `
                      <div class="bg-white px-3 py-2 md:py-3 rounded-2xl border-2 border-indigo-200 text-indigo-800 font-black text-xs md:text-sm text-center shadow-inner animate-in fade-in zoom-in w-full">
                        ${state.pronunciationFeedback}
                      </div>
                    ` : ''}
                  </div>
                ` : `
                  <div class="text-slate-400 font-bold uppercase text-[9px] md:text-[10px] tracking-[0.2em] flex flex-col items-center gap-2 animate-pulse bg-slate-100 p-2 rounded-xl w-full">
                    <div class="flex items-center gap-2"><i data-lucide="mouse-pointer-click" class="w-3.5 h-3.5"></i> Dokunarak veya s√ºr√ºkleyerek oyna!</div>
                  </div>
                `}
              </div>
            </div>

            <!-- ALT MEN√ú -->
            <footer class="h-40 md:h-56 bg-white border-t border-slate-200 flex flex-row shadow-inner shrink-0 relative z-20">
              <div class="w-1/3 border-r border-slate-100 flex flex-col">
                <h3 class="bg-indigo-600 text-white text-[9px] md:text-[10px] font-black uppercase tracking-widest text-center py-1 md:py-2 flex items-center justify-center gap-1">
                   <i data-lucide="zap" class="w-2.5 h-2.5"></i> BEK√áƒ∞LER
                </h3>
                <div class="flex-1 overflow-y-auto p-1 md:p-2 flex flex-wrap gap-1 md:gap-2 content-start justify-center custom-scrollbar">
                  ${(() => {
                    if (state.mode === 'question') return (cData.auxiliaries || []).map(a => renderPuzzlePiece({ type: 'aux', color: '#6366f1', content: a, isSelectedPiece: sp?.type === 'aux' && sp?.value === a, shape: 'AUX_START' })).join('');
                    if (state.mode === 'negative') return ["don't", "doesn't"].map(a => renderPuzzlePiece({ type: 'aux', color: '#ec4899', content: a, isSelectedPiece: sp?.type === 'aux' && sp?.value === a, shape: 'BE_MODAL' })).join('');
                    if (state.mode === 'modal') return (cData.modals || []).map(a => renderPuzzlePiece({ type: 'modal', color: '#f59e0b', content: a, isSelected: state.sentence.modal === a, isSelectedPiece: sp?.type === 'modal' && sp?.value === a, shape: 'BE_MODAL' })).join('');
                    if (state.mode === 'status' || state.mode === 'continuous') return (cData.statusAux || []).map(a => renderPuzzlePiece({ type: 'aux', color: '#0d9488', content: a, isSelected: state.sentence.aux === a, isSelectedPiece: sp?.type === 'aux' && sp?.value === a, shape: 'BE_MODAL' })).join('');
                    return `<div class="text-[9px] md:text-[10px] text-slate-300 italic text-center mt-6">Bek√ßi yok! ‚ú®</div>`;
                  })()}
                </div>
              </div>

              <div class="w-2/3 flex flex-col">
                <h3 class="bg-red-600 text-white text-[9px] md:text-[10px] font-black uppercase tracking-widest text-center py-1 md:py-2 flex items-center justify-center gap-1">
                   <i data-lucide="puzzle" class="w-2.5 h-2.5"></i> EYLEMLER
                </h3>
                <div class="flex-1 overflow-y-auto p-1 md:p-2 flex flex-wrap gap-1 md:gap-2 content-start justify-center custom-scrollbar">
                  ${state.mode !== 'status' ? (cData.verbs || []).map(v => {
                    if (state.mode === 'continuous') {
                      const ingVal = v.split(' ')[0] + 'ing ' + (v.split(' ')[1] || '');
                      return renderPuzzlePiece({ type: 'ingVerb', color: '#f97316', content: ingVal, isSelected: state.sentence.ingVerb === ingVal, isSelectedPiece: sp?.type === 'ingVerb' && sp?.value === ingVal, shape: 'VERB_ING' });
                    }
                    return renderPuzzlePiece({ type: 'verb', color: state.mode === 'negative' ? '#f97316' : '#ef4444', content: v, isSelected: state.sentence.verb === v, isSelectedPiece: sp?.type === 'verb' && sp?.value === v, shape: (state.mode === 'modal' || state.mode === 'negative') ? 'VERB_BASE' : 'VERB_SIMPLE' });
                  }).join('') : `<div class="text-[9px] md:text-[10px] text-slate-300 italic text-center mt-6">Durumda hareket olmaz! üåâ</div>`}
                </div>
              </div>
              <button data-action="reset" class="absolute bottom-2 right-2 md:bottom-4 md:right-4 bg-slate-900 text-white p-2 md:p-3 rounded-full hover:bg-orange-600 shadow-lg active:scale-95 group z-30"><i data-lucide="refresh-cw" class="w-5 h-5 md:w-6 md:h-6 group-hover:rotate-180 transition-transform duration-500"></i></button>
            </footer>
          </main>

          <!-- SAƒû MEN√ú -->
          <aside class="fixed md:relative inset-y-0 right-0 w-64 md:w-72 bg-white border-l border-slate-200 flex flex-col shadow-2xl md:shadow-inner z-40 transform transition-transform duration-300 md:translate-x-0 shrink-0 ${state.rightDrawerOpen ? 'translate-x-0' : 'translate-x-full'}">
            <div class="bg-green-600 text-white text-[10px] font-black uppercase tracking-widest text-center py-3 italic shadow-sm flex items-center justify-center relative">
              <button class="md:hidden absolute left-3 text-green-200 hover:text-white" data-action="close-drawers"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
              ${state.mode === 'status' ? "NASIL? (ADJECTIVE)" : "NEYƒ∞? (OBJECT)"}
            </div>
            <div class="flex-1 overflow-y-auto p-4 flex flex-wrap content-start gap-2 custom-scrollbar">
              ${state.mode === 'status' ? (cData.adjectives || []).map(adj => renderPuzzlePiece({ type: 'adjective', color: '#8b5cf6', content: adj, isSelected: state.sentence.adjective === adj, isSelectedPiece: sp?.type === 'adjective' && sp?.value === adj, shape: 'ADJECTIVE' })).join('') :
                (cData.objects || []).map(o => renderPuzzlePiece({ type: 'object', color: '#22c55e', content: o, isSelected: state.sentence.object === o, isSelectedPiece: sp?.type === 'object' && sp?.value === o, shape: 'OBJ_END' })).join('')}
            </div>
          </aside>
        </div>
      `;
    };

    // --- MAIN RENDER AND EVENT DELEGATION ---
    const updateUI = () => {
      document.getElementById('root').innerHTML = state.showLogin ? renderLogin() : renderApp();
      lucide.createIcons();
    };

    document.addEventListener('input', (e) => {
      if (e.target.id === 'nameInput') state.nameInput = e.target.value;
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.id === 'nameInput') {
        if(state.nameInput.trim()) { state.userName = state.nameInput.trim(); state.showLogin = false; updateUI(); }
      }
    });

    document.addEventListener('click', (e) => {
      const actionEl = e.target.closest('[data-action]');
      if (!actionEl) return;
      const action = actionEl.dataset.action;
      const payload = actionEl.dataset.payload;

      if (action === 'start-game') {
        if(state.nameInput.trim()) { state.userName = state.nameInput.trim(); state.showLogin = false; updateUI(); }
      } else if (action === 'set-category') {
        state.activeCategory = payload; resetGame(); updateUI();
      } else if (action === 'set-mode') {
        state.mode = payload; resetGame(); updateUI();
      } else if (action === 'reset') {
        resetGame(); updateUI();
      } else if (action === 'toggle-left-drawer') {
        state.leftDrawerOpen = true; updateUI();
      } else if (action === 'toggle-right-drawer') {
        state.rightDrawerOpen = true; updateUI();
      } else if (action === 'close-drawers') {
        state.leftDrawerOpen = false; state.rightDrawerOpen = false; updateUI();
      } else if (action === 'close-funny-mistake') {
        state.funnyMistake = null; updateUI();
      } else if (action === 'piece-click') {
        state.selectedPiece = { type: actionEl.dataset.type, value: actionEl.dataset.value };
        updateUI();
      } else if (action === 'slot-click') {
        if (!state.selectedPiece) return;
        processPlacement(actionEl.dataset.type, state.selectedPiece);
      } else if (action === 'toggle-recording') {
        toggleRecording();
      }
    });

    // DRAG AND DROP
    document.addEventListener('dragstart', (e) => {
      const piece = e.target.closest('.puzzle-piece');
      if (piece && piece.hasAttribute('draggable')) {
        e.dataTransfer.setData("text/plain", JSON.stringify({ type: piece.dataset.type, value: piece.dataset.value }));
      }
    });

    document.addEventListener('dragover', (e) => {
      const slot = e.target.closest('.puzzle-slot');
      if (slot) {
        e.preventDefault();
        if (currentDragSlot !== slot) {
          if (currentDragSlot) currentDragSlot.classList.remove('scale-105', 'drop-shadow-2xl', 'z-20', 'brightness-105');
          slot.classList.add('scale-105', 'drop-shadow-2xl', 'z-20', 'brightness-105');
          currentDragSlot = slot;
        }
      }
    });

    document.addEventListener('dragleave', (e) => {
      const slot = e.target.closest('.puzzle-slot');
      if (slot && currentDragSlot === slot) {
        slot.classList.remove('scale-105', 'drop-shadow-2xl', 'z-20', 'brightness-105');
        currentDragSlot = null;
      }
    });

    document.addEventListener('drop', (e) => {
      const slot = e.target.closest('.puzzle-slot');
      if (currentDragSlot) {
        currentDragSlot.classList.remove('scale-105', 'drop-shadow-2xl', 'z-20', 'brightness-105');
        currentDragSlot = null;
      }
      if (slot) {
        e.preventDefault();
        const dataStr = e.dataTransfer.getData("text/plain");
        if (!dataStr) return;
        try {
          processPlacement(slot.dataset.type, JSON.parse(dataStr));
        } catch(err) {}
      }
    });

    // Initialize
    updateUI();
  </script>
</body>
</html>