<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Robo-Kanka Ultimate Emoji Academy (Secure & Full)</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #0ea5e9;
      --secondary-color: #e0f2fe;
      --accent-color: #f43f5e;
      --success-color: #22c55e;
      --bg-color: #f0f9ff;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
      height: 100vh;
      /* Mobil tarayƒ±cƒ± adres √ßubuƒüu sorununu √ß√∂zer */
      height: 100dvh; 
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: 0;
    }

    /* === COMMON COMPONENTS === */
    .custom-scroll { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #93c5fd transparent; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 10px; }

    .app-card {
      background: white;
      border-radius: 15px; /* Mobilde daha az yuvarlak k√∂≈üe yer kazandƒ±rƒ±r */
      border: none;
      box-shadow: 0 4px 10px rgba(14, 165, 233, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      height: 100%;
      width: 100%;
    }

    .lesson-item {
      padding: 12px 15px;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      background: #f8fafc;
      display: flex; align-items: center;
    }
    .lesson-item:hover { background-color: #e0f2fe; }
    .lesson-item.active { background-color: #fff; border-color: #0ea5e9; color: #0284c7; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.15); }
    
    .chat-box { flex-grow: 1; overflow-y: auto; padding: 10px; background-image: radial-gradient(#e0f2fe 1px, transparent 1px); background-size: 20px 20px; }
    .chat-bubble {
      max-width: 85%;
      border-radius: 15px;
      padding: 8px 12px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      line-height: 1.3;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      animation: popIn 0.3s;
    }
    .chat-ai { background: white; border: 1px solid #e0f2fe; color: #334155; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 4px; }
    .chat-user { background: #0ea5e9; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 4px; }

    .slide-story { color: #64748b; font-weight: 600; display: block; margin-top:5px; font-size: 0.9em; }

    .grammar-box { background: #fff; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center; padding: 10px; margin-top: 5px; }
    .g-block { display: inline-block; border-radius: 8px; color: white; font-weight: bold; margin: 2px; padding: 4px 8px; font-size: 0.9rem; }
    .gb-sub { background: #3b82f6; } .gb-verb { background: #ef4444; } .gb-obj { background: #22c55e; } .gb-adj { background: #f59e0b; } .gb-prep { background: #8b5cf6; }

    #robotFace { transition: transform 0.3s; }
    .mic-btn-lg {
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
      border: 3px solid white;
      transition: all 0.2s;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }
    .mic-btn-lg:active { transform: scale(0.9); }
    .mic-active { background: #f43f5e !important; animation: pulse-big 1s infinite; }

    #startOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f9ff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
    .login-box { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }

    .progress-container { width: 100%; height: 6px; background-color: #f1f5f9; position: absolute; top: 0; left: 0; z-index: 10; }
    .progress-bar { height: 100%; background-color: var(--success-color); transition: width 0.3s ease; }

    /* === LAYOUT FIXES FOR DESKTOP === */
    @media (min-width: 992px) {
      .app-container {
        flex-grow: 1;
        padding: 20px !important;
        overflow: hidden;
        height: 100%;
      }
      .row { height: 100%; }
      .col-lg-3, .col-lg-5, .col-lg-4 {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .sidebar-col { display: flex !important; flex-direction: column; height: 100%; }
      .mobile-nav { display: none !important; }
      
      /* Desktop Sizes */
      #robotFace { width: 160px; height: 160px; }
      .mic-btn-lg { width: 70px; height: 70px; font-size: 2rem; }
      .slide-visual { font-size: 6rem; margin-bottom: 20px; text-shadow: 0 5px 15px rgba(0,0,0,0.1); }
      .slide-text { font-size: 1.6rem; padding: 20px 30px; font-weight: 800; color: #1e293b; background: rgba(255,255,255,0.9); border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid #f1f5f9; display: inline-block; max-width: 95%; }
    }

    /* === MOBILE LAYOUT (Compact Fit) === */
    @media (max-width: 991.98px) {
      .mobile-nav {
        flex-shrink: 0;
        height: 50px;
        padding: 5px 15px;
        z-index: 1030;
      }
      
      .app-container {
        padding: 5px !important;
        height: calc(100dvh - 50px);
        overflow: hidden; /* No scroll on container */
        display: flex;
        flex-direction: column;
      }

      .row {
        flex: 1;
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        gap: 8px; /* Small gap */
        margin: 0;
        height: 100%;
      }

      /* Top Panel: Robot + Chat (55% height) */
      .col-lg-5 {
        flex: 55; 
        height: 55%;
        min-height: 0;
        padding: 0;
        width: 100%;
      }
      
      /* Bottom Panel: Board (45% height) */
      .col-lg-4 {
        flex: 45;
        height: 45%;
        min-height: 0;
        padding: 0;
        width: 100%;
      }

      /* Compact Robot UI */
      .col-lg-5 .text-center {
        padding-top: 5px !important;
        padding-bottom: 2px !important;
      }
      #robotFace { width: 80px; height: 80px; }
      #statusBadge { font-size: 0.7rem; padding: 2px 8px !important; }
      
      /* Compact Controls */
      .col-lg-5 .p-3.border-top { padding: 5px !important; }
      .mic-btn-lg { width: 50px; height: 50px; font-size: 1.5rem; }
      .btn-info, .btn-warning { width: 40px !important; height: 40px !important; padding: 0 !important; }
      .btn-info i, .btn-warning i { font-size: 1.2rem !important; }
      #micStatusText { display: none; } /* Save space */

      /* Compact Board UI */
      .slide-visual { font-size: 3.5rem; margin-bottom: 5px; text-shadow: 0 3px 10px rgba(0,0,0,0.1); }
      .slide-text { font-size: 1.1rem; padding: 8px 15px; margin-bottom: 5px; font-weight: 800; color: #1e293b; background: rgba(255,255,255,0.9); border-radius: 15px; border: 1px solid #f1f5f9; display: inline-block; max-width: 98%; }
      #boardPanel .p-4 { padding: 10px !important; }
      #boardPanel .mt-4 { margin-top: 5px !important; }
      
      /* Sidebar Offcanvas */
      .sidebar-col {
        position: fixed;
        width: 280px;
        top: 0; bottom: 0; left: -320px;
        z-index: 1050;
        background: white;
        transition: left 0.3s;
        padding: 0;
        box-shadow: 5px 0 20px rgba(0,0,0,0.2);
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .sidebar-col.show { left: 0; }
      .backdrop {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
        display: none;
      }
      .backdrop.show { display: block; }
    }

    /* Animations */
    @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulse-big { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes slide-in-right { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes error-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

    .anim-float { animation: float 3s infinite ease-in-out; }
    .anim-shake { animation: shake 1.5s infinite; }
    .anim-pulse { animation: pulse-big 1.2s infinite; }
    .anim-spin { animation: spin-slow 10s infinite linear; }
    .anim-error { animation: error-shake 0.3s; }
  </style>
</head>
<body>

<!-- Login -->
<div id="startOverlay">
  <div class="login-box">
    <div class="display-1 mb-3 anim-float">ü§ñ</div>
    <h1 class="h3 fw-bold text-primary mb-1">Robo-Kanka</h1>
    <p class="text-secondary small mb-4">Ultimate Emoji Academy üéì</p>
    <div class="mb-3"><input type="password" id="passwordInput" class="form-control form-control-lg text-center rounded-pill bg-light border-0" placeholder="Password"></div>
    <div id="loginError" class="text-danger fw-bold small mb-3" style="display:none;">üö´ Incorrect!</div>
    <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm" onclick="app.checkLogin()">LOGIN üöÄ</button>
  </div>
  <div class="mt-4 text-muted small"><i class="bi bi-lock-fill"></i> 2244TAYLAN</div>
</div>

<!-- Mobile Header -->
<nav class="mobile-nav d-lg-none d-flex justify-content-between align-items-center bg-white p-2 shadow-sm sticky-top">
  <button class="btn btn-light rounded-circle shadow-sm text-primary" onclick="app.toggleSidebar()"><i class="bi bi-list fs-3"></i></button>
  <span class="fw-bold text-primary fs-5">Robo-Kanka</span>
  <span class="badge bg-warning text-dark rounded-pill" id="mobileScore">‚≠ê 0</span>
</nav>
<div class="backdrop" id="backdrop" onclick="app.toggleSidebar()"></div>

<!-- Main App -->
<div class="app-container container-fluid" id="mainContent" style="filter: blur(5px);">
  <div class="row g-3">
    
    <!-- LEFT: Menu -->
    <div class="col-lg-3 sidebar-col" id="sidebar">
      <div class="app-card">
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-white">
          <h5 class="fw-bold text-primary m-0"><i class="bi bi-map me-2"></i>Map</h5>
          <button class="btn btn-sm btn-close d-lg-none" onclick="app.toggleSidebar()"></button>
        </div>
        <div class="p-2 custom-scroll flex-grow-1 bg-white">
          <div id="lessonList"></div>
        </div>
        <div class="p-3 border-top text-center bg-light">
          <button class="btn btn-outline-danger btn-sm rounded-pill w-100" onclick="app.resetProgress()">Reset Progress</button>
        </div>
      </div>
    </div>

    <!-- MIDDLE: Robot -->
    <div class="col-lg-5">
      <div class="app-card h-100-responsive">
        <div class="card-body p-0 d-flex flex-column h-100">
          <div class="text-center pt-3 pb-2 bg-gradient-to-b from-blue-50 to-white flex-shrink-0">
            <div id="robotFace" class="mx-auto"></div>
            <div class="mt-2"><span class="badge bg-success bg-opacity-25 text-success border border-success rounded-pill px-3 py-1" id="statusBadge">Ready!</span></div>
          </div>
          <div id="chatBox" class="chat-box custom-scroll"></div>
          <div class="p-3 bg-white border-top flex-shrink-0">
            <div class="d-flex align-items-center justify-content-center gap-4">
              <button class="btn btn-info rounded-circle p-3 text-white shadow" style="width:55px;height:55px;" onclick="app.repeat()" title="Repeat"><i class="bi bi-arrow-repeat fs-4"></i></button>
              <button id="micBtn" class="mic-btn-lg" onclick="app.toggleMic()"><i class="bi bi-mic-fill"></i></button>
              <button class="btn btn-warning rounded-circle p-3 text-dark shadow" style="width:55px;height:55px;" onclick="app.hint()" title="Hint"><i class="bi bi-lightbulb-fill fs-4"></i></button>
            </div>
            <div class="text-center mt-2 text-muted fw-bold small" id="micStatusText">Tap to Speak</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Board -->
    <div class="col-lg-4">
      <div class="app-card border-top border-5 border-info h-100-responsive position-relative">
        <div class="progress-container"><div id="lessonProgressBar" class="progress-bar" style="width: 0%"></div></div>
        <div id="boardPanel" class="card-body p-0 h-100 position-relative d-flex flex-column">
          <div class="d-flex h-100 justify-content-center align-items-center text-muted opacity-25">
            <div class="text-center"><i class="bi bi-easel display-1"></i><p class="fs-5 fw-bold">Smart Board</p></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// FULL 40 LESSONS CONTENT
const LESSONS = [
  // UNIT 1: BASICS
  { title: "1. Hello! üëã", slides:[{v:"üëã",t:"Hello",s:"Hello! Wave your hand!"},{v:"üåû",t:"Good Morning",s:"Sun is up!"},{v:"üåõ",t:"Good Night",s:"Moon is up."},{v:"üòä",t:"I am Happy",s:"Big smile!"}], chat:[{q:"What is your name?",k:["name","is"],s:"Nice name!",f:"My name is..."},{q:"How are you?",k:["fine","good","happy"],s:"Great!",f:"I am happy."}], grammar:[{t:"Intro",r:"My Name + is",b:[{t:"My Name",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Robo",c:"gb-obj"}]}], quiz:[{q:"Sun up?",o:["Morning","Night"],c:0}] },
  { title: "2. Colors üé®", slides:[{v:"üçé",t:"Red",s:"Red Apple"},{v:"üöô",t:"Blue",s:"Blue Car"},{v:"üê∏",t:"Green",s:"Green Frog"},{v:"üçå",t:"Yellow",s:"Yellow Banana"}], chat:[{q:"Color of sun?",k:["yellow"],s:"Yes!",f:"Yellow"},{q:"Color of grass?",k:["green"],s:"Correct",f:"Green"}], grammar:[{t:"Desc",r:"It + is + Color",b:[{t:"It",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Red",c:"gb-adj"}]}], quiz:[{q:"Yellow fruit?",o:["Banana","Apple"],c:0}] },
  { title: "3. Numbers üî¢", slides:[{v:"1Ô∏è‚É£",t:"One",s:"One Lion"},{v:"2Ô∏è‚É£",t:"Two",s:"Two Eyes"},{v:"3Ô∏è‚É£",t:"Three",s:"Three Balls"},{v:"5Ô∏è‚É£",t:"Five",s:"High Five"}], chat:[{q:"1, 2...?",k:["3","three"],s:"Yes 3",f:"Three"},{q:"Fingers?",k:["5","five"],s:"Five!",f:"Five"}], grammar:[{t:"Count",r:"Num + Noun",b:[{t:"Three",c:"gb-adj"},{t:"Cats",c:"gb-obj"}]}], quiz:[{q:"1+1?",o:["2","3"],c:0}] },
  { title: "4. Family üë®‚Äçüë©‚Äçüëß", slides:[{v:"üë©",t:"Mom",s:"Super Mom"},{v:"üë®",t:"Dad",s:"Super Dad"},{v:"üë∂",t:"Baby",s:"Cute baby"},{v:"üëµ",t:"Grandma",s:"Grandma"}], chat:[{q:"Who is dad?",k:["father"],s:"Yes",f:"Father"},{q:"Mom?",k:["mother"],s:"Yes",f:"Mother"}], grammar:[{t:"Poss",r:"My + Person",b:[{t:"My",c:"gb-adj"},{t:"Mom",c:"gb-obj"}]}], quiz:[{q:"Dad is...",o:["Father","Sister"],c:0}] },
  { title: "5. Animals ü¶Å", slides:[{v:"ü¶Å",t:"Lion",s:"Roar!"},{v:"üêò",t:"Elephant",s:"Big nose"},{v:"üêµ",t:"Monkey",s:"Ooh ooh"},{v:"ü¶í",t:"Giraffe",s:"Very tall"}], chat:[{q:"Says Roar?",k:["lion"],s:"Scary!",f:"Lion"}], grammar:[{t:"Desc",r:"It is + Adj",b:[{t:"It",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Big",c:"gb-adj"}]}], quiz:[{q:"Big animal?",o:["Ant","Elephant"],c:1}] },
  { title: "6. Body üëÉ", slides:[{v:"üëÉ",t:"Nose",s:"Smell"},{v:"üëÄ",t:"Eyes",s:"See"},{v:"üëÇ",t:"Ears",s:"Hear"},{v:"üëÑ",t:"Mouth",s:"Taste"}], chat:[{q:"Smell with?",k:["nose"],s:"Good",f:"Nose"}], grammar:[{t:"Func",r:"I + Verb + with",b:[{t:"I",c:"gb-sub"},{t:"See",c:"gb-verb"},{t:"with Eyes",c:"gb-obj"}]}], quiz:[{q:"See with...",o:["Ears","Eyes"],c:1}] },
  { title: "7. Clothes üëï", slides:[{v:"üëï",t:"Shirt",s:"Cool shirt"},{v:"üß¢",t:"Hat",s:"Sun hat"},{v:"üëñ",t:"Jeans",s:"Blue pants"},{v:"üëó",t:"Dress",s:"Pretty dress"}], chat:[{q:"On head?",k:["hat"],s:"Yes",f:"Hat"}], grammar:[{t:"Wear",r:"I + wear",b:[{t:"I",c:"gb-sub"},{t:"wear",c:"gb-verb"},{t:"Hat",c:"gb-obj"}]}], quiz:[{q:"On feet?",o:["Hat","Shoes"],c:1}] },
  { title: "8. Fruit üçé", slides:[{v:"üçé",t:"Apple",s:"Red"},{v:"üçå",t:"Banana",s:"Yellow"},{v:"üçá",t:"Grape",s:"Purple"},{v:"üçã",t:"Lemon",s:"Sour!"}], chat:[{q:"Red fruit?",k:["apple"],s:"Yum",f:"Apple"}], grammar:[{t:"Like",r:"I + Like",b:[{t:"I",c:"gb-sub"},{t:"Like",c:"gb-verb"},{t:"Fruit",c:"gb-obj"}]}], quiz:[{q:"Yellow?",o:["Banana","Grape"],c:0}] },
  { title: "9. Food üçï", slides:[{v:"üçï",t:"Pizza",s:"Yum"},{v:"üçî",t:"Burger",s:"Big"},{v:"üç¶",t:"Ice Cream",s:"Cold"},{v:"ü•ó",t:"Salad",s:"Healthy"}], chat:[{q:"Hungry?",k:["yes"],s:"Eat!",f:"Yes"}], grammar:[{t:"Want",r:"I + Want",b:[{t:"I",c:"gb-sub"},{t:"Want",c:"gb-verb"},{t:"Pizza",c:"gb-obj"}]}], quiz:[{q:"Drink?",o:["Water","Pizza"],c:0}] },
  { title: "10. House üè†", slides:[{v:"üè†",t:"Home",s:"My house"},{v:"üõèÔ∏è",t:"Bed",s:"Sleep"},{v:"üõÅ",t:"Bath",s:"Wash"},{v:"üç≥",t:"Kitchen",s:"Cook"}], chat:[{q:"Sleep where?",k:["bed"],s:"Zzz",f:"Bed"}], grammar:[{t:"Loc",r:"In + Room",b:[{t:"In",c:"gb-prep"},{t:"Room",c:"gb-obj"}]}], quiz:[{q:"Cook in...",o:["Kitchen","Bath"],c:0}] },
  
  // UNIT 2: SCHOOL & ACTIONS
  { title: "11. School Objects üéí", slides:[{v:"üéí",t:"Bag",s:"Put books in bag."}, {v:"‚úèÔ∏è",t:"Pencil",s:"Write with pencil."}, {v:"üìö",t:"Book",s:"Read a book."}, {v:"‚úÇÔ∏è",t:"Scissors",s:"Cut paper."}, {v:"üè´",t:"School",s:"We learn here."}, {v:"üìè",t:"Ruler",s:"Measure lines."}], chat:[{q:"Write with?",k:["pencil","pen"],s:"Good job!",f:"Pencil"},{q:"Read a...?",k:["book"],s:"Smart!",f:"Book"}], grammar:[{t:"Obj",r:"This is + a + Noun",b:[{t:"This",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"a Pen",c:"gb-obj"}]}], quiz:[{q:"Cut with...",o:["Scissors","Ruler"],c:0}] },
  { title: "12. Actions I üèÉ", slides:[{v:"üèÉ",t:"Run",s:"Run fast!"}, {v:"üö∂",t:"Walk",s:"Walk slow."}, {v:"ü§∏",t:"Jump",s:"Jump high!"}, {v:"üèä",t:"Swim",s:"Swim in water."}, {v:"üßò",t:"Sit",s:"Sit down."}, {v:"üßç",t:"Stand",s:"Stand up."}], chat:[{q:"Can you jump?",k:["yes"],s:"Boing!",f:"Yes"},{q:"Fish can...?",k:["swim"],s:"Splash",f:"Swim"}], grammar:[{t:"Ability",r:"I + Can + Verb",b:[{t:"I",c:"gb-sub"},{t:"Can",c:"gb-verb"},{t:"Run",c:"gb-obj"}]}], quiz:[{q:"Opposite of Run?",o:["Walk","Fly"],c:0}] },
  { title: "13. Daily Routine ‚òÄÔ∏è", slides:[{v:"ü•±",t:"Wake up",s:"Open eyes."}, {v:"ü¶∑",t:"Brush",s:"Clean teeth."}, {v:"üöø",t:"Shower",s:"Wash body."}, {v:"üëó",t:"Dress",s:"Put on clothes."}, {v:"üç≥",t:"Eat",s:"Breakfast time."}, {v:"üöå",t:"Go",s:"Go to school."}], chat:[{q:"First thing?",k:["wake"],s:"Good morning",f:"Wake up"},{q:"Clean teeth with?",k:["brush"],s:"Sparkle",f:"Brush"}], grammar:[{t:"Routine",r:"I + Verb",b:[{t:"I",c:"gb-sub"},{t:"Wake up",c:"gb-verb"}]}], quiz:[{q:"Morning meal?",o:["Breakfast","Dinner"],c:0}] },
  { title: "14. Plurals üêàüêà", slides:[{v:"üêà",t:"Cat",s:"One cat."}, {v:"üêàüêà",t:"Cats",s:"Two cats (s)."}, {v:"üöå",t:"Bus",s:"One bus."}, {v:"üöåüöå",t:"Buses",s:"Two buses (es)."}, {v:"üì¶",t:"Box",s:"One box."}, {v:"üì¶üì¶",t:"Boxes",s:"Many boxes (es)."}], chat:[{q:"One dog, two...?",k:["dogs"],s:"Yes S",f:"Dogs"},{q:"One bus, two...?",k:["buses"],s:"Yes ES",f:"Buses"}], grammar:[{t:"Plural",r:"Noun + s/es",b:[{t:"One",c:"gb-adj"},{t:"Cat",c:"gb-sub"},{t:"Two",c:"gb-adj"},{t:"Cats",c:"gb-sub"}]}], quiz:[{q:"3...",o:["Bird","Birds"],c:1}] },
  { title: "15. This / That üëâ", slides:[{v:"üëá",t:"This",s:"This apple (near)."}, {v:"üëâ",t:"That",s:"That star (far)."}, {v:"üëáüê∂",t:"This Dog",s:"My dog here."}, {v:"üëâüê±",t:"That Cat",s:"Your cat there."}, {v:"üëá‚úèÔ∏è",t:"This Pen",s:"In my hand."}, {v:"üëâ‚úàÔ∏è",t:"That Plane",s:"In the sky."}], chat:[{q:"Is the sun This or That?",k:["that"],s:"Far away",f:"That"},{q:"My nose is...",k:["this"],s:"Near",f:"This"}], grammar:[{t:"Pointer",r:"This (Near) / That (Far)",b:[{t:"This",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"my Pen",c:"gb-obj"}]}], quiz:[{q:"Far away is...",o:["That","This"],c:0}] },
  { title: "16. Adjectives üêò", slides:[{v:"üêò",t:"Big",s:"Elephant is big."}, {v:"üêú",t:"Small",s:"Ant is small."}, {v:"üî•",t:"Hot",s:"Fire is hot."}, {v:"‚ùÑÔ∏è",t:"Cold",s:"Ice is cold."}, {v:"üöÄ",t:"Fast",s:"Rocket is fast."}, {v:"üê¢",t:"Slow",s:"Turtle is slow."}], chat:[{q:"Mouse is?",k:["small"],s:"Tiny",f:"Small"},{q:"Ice cream is?",k:["cold"],s:"Brr",f:"Cold"}], grammar:[{t:"Desc",r:"It + is + Adj",b:[{t:"It",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Big",c:"gb-adj"}]}], quiz:[{q:"Whale?",o:["Big","Small"],c:0}] },
  { title: "17. Feelings üòä", slides:[{v:"üòä",t:"Happy",s:"I smile."}, {v:"üò¢",t:"Sad",s:"I cry."}, {v:"üò°",t:"Angry",s:"I am mad."}, {v:"üò¥",t:"Tired",s:"I want sleep."}, {v:"üò®",t:"Scared",s:"I am afraid."}, {v:"ü§£",t:"Funny",s:"I laugh."}], chat:[{q:"Are you happy?",k:["yes"],s:"Smile!",f:"Yes"},{q:"Ghost is...",k:["scary"],s:"Boo!",f:"Scary"}], grammar:[{t:"Feel",r:"I + am + Adj",b:[{t:"I",c:"gb-sub"},{t:"am",c:"gb-verb"},{t:"Happy",c:"gb-adj"}]}], quiz:[{q:"Crying means...",o:["Sad","Happy"],c:0}] },
  { title: "18. Jobs üëÆ", slides:[{v:"üëÆ",t:"Police",s:"Helps people."}, {v:"üë®‚Äç‚öïÔ∏è",t:"Doctor",s:"Cures sick."}, {v:"üë®‚Äçüè´",t:"Teacher",s:"Teaches school."}, {v:"üë®‚Äçüç≥",t:"Cook",s:"Makes food."}, {v:"üë®‚Äçüöí",t:"Fireman",s:"Fights fire."}, {v:"üßë‚Äçüåæ",t:"Farmer",s:"Grows food."}], chat:[{q:"Help sick?",k:["doctor"],s:"Yes",f:"Doctor"},{q:"Makes food?",k:["cook","chef"],s:"Yum",f:"Cook"}], grammar:[{t:"Job",r:"He/She + is + a + Job",b:[{t:"He",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"a Cook",c:"gb-obj"}]}], quiz:[{q:"Works in kitchen?",o:["Cook","Police"],c:0}] },
  { title: "19. Weather ‚òÅÔ∏è", slides:[{v:"‚òÄÔ∏è",t:"Sunny",s:"Wear hat."}, {v:"üåßÔ∏è",t:"Rainy",s:"Take umbrella."}, {v:"‚òÅÔ∏è",t:"Cloudy",s:"No sun."}, {v:"‚ùÑÔ∏è",t:"Snowy",s:"Make snowman."}, {v:"üí®",t:"Windy",s:"Fly kite."}, {v:"‚õàÔ∏è",t:"Stormy",s:"Boom!"}], chat:[{q:"Is it raining?",k:["no","yes"],s:"Look outside",f:"Yes/No"},{q:"Hot weather?",k:["sunny"],s:"Beach time",f:"Sunny"}], grammar:[{t:"Weather",r:"It + is + Adj",b:[{t:"It",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Sunny",c:"gb-adj"}]}], quiz:[{q:"Fly kite when...",o:["Windy","Rainy"],c:0}] },
  { title: "20. Days of Week üìÖ", slides:[{v:"1Ô∏è‚É£",t:"Monday",s:"First day."}, {v:"2Ô∏è‚É£",t:"Tuesday",s:"Second day."}, {v:"3Ô∏è‚É£",t:"Wednesday",s:"Middle."}, {v:"4Ô∏è‚É£",t:"Thursday",s:"Almost there."}, {v:"5Ô∏è‚É£",t:"Friday",s:"Last school day."}, {v:"üéâ",t:"Weekend",s:"Sat & Sun!"}], chat:[{q:"School starts?",k:["monday"],s:"Yes",f:"Monday"},{q:"Rest days?",k:["weekend","sunday"],s:"Play!",f:"Weekend"}], grammar:[{t:"Time",r:"Today + is + Day",b:[{t:"Today",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Friday",c:"gb-obj"}]}], quiz:[{q:"Days in week?",o:["7","5"],c:0}] },
  
  // --- UNIT 3: INTERMEDIATE CONCEPTS ---
  { title: "21. Four Seasons üçÇ", slides:[{v:"‚ùÑÔ∏è",t:"Winter",s:"Snow and cold."}, {v:"üå∏",t:"Spring",s:"Flowers bloom."}, {v:"‚òÄÔ∏è",t:"Summer",s:"Hot sun."}, {v:"üçÇ",t:"Autumn",s:"Leaves fall."}, {v:"‚òÉÔ∏è",t:"Snowman",s:"Build in winter."}, {v:"üèñÔ∏è",t:"Beach",s:"Swim in summer."}], chat:[{q:"When is it hot?",k:["summer"],s:"Ice cream time!",f:"Summer"},{q:"When do flowers grow?",k:["spring"],s:"Lovely",f:"Spring"}], grammar:[{t:"Season",r:"In + Season",b:[{t:"In",c:"gb-prep"},{t:"Summer",c:"gb-obj"}]}], quiz:[{q:"Snow in...",o:["Winter","Summer"],c:0}] },
  { title: "22. Time ‚è∞", slides:[{v:"üïò",t:"9:00",s:"Nine O'clock."}, {v:"üïõ",t:"12:00",s:"Lunch time."}, {v:"üïí",t:"3:00",s:"Play time."}, {v:"üïï",t:"6:00",s:"Dinner time."}, {v:"üï§",t:"9:30",s:"Sleep time."}, {v:"‚åö",t:"Watch",s:"On your arm."}], chat:[{q:"What time is lunch?",k:["12","twelve"],s:"Yum",f:"12"},{q:"Tells time?",k:["clock","watch"],s:"Tick tock",f:"Clock"}], grammar:[{t:"Time",r:"It + is + Time",b:[{t:"It",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Five",c:"gb-obj"}]}], quiz:[{q:"Sleep at...",o:["Night","Morning"],c:0}] },
  { title: "23. Actions 2 üèä", slides:[{v:"üèä",t:"Swim",s:"Pool fun."}, {v:"üö≤",t:"Bike",s:"Ride bike."}, {v:"üßó",t:"Climb",s:"Go up tree."}, {v:"üé®",t:"Paint",s:"Use colors."}, {v:"üé§",t:"Sing",s:"La la la."}, {v:"üç≥",t:"Cook",s:"Make food."}], chat:[{q:"Can you sing?",k:["yes","no"],s:"La la la",f:"Yes"},{q:"Ride a...?",k:["bike"],s:"Helmet on",f:"Bike"}], grammar:[{t:"Do",r:"I + Verb",b:[{t:"I",c:"gb-sub"},{t:"Swim",c:"gb-verb"}]}], quiz:[{q:"In pool we...",o:["Swim","Fly"],c:0}] },
  { title: "24. Can / Can't ü¶Ö", slides:[{v:"ü¶Ö",t:"Fly",s:"Birds CAN fly."}, {v:"üêß",t:"No Fly",s:"Penguins CAN'T."}, {v:"üêü",t:"Swim",s:"Fish CAN swim."}, {v:"üêà",t:"No Swim",s:"Cats CAN'T swim."}, {v:"üèÉ",t:"Run",s:"I CAN run."}, {v:"üöô",t:"Drive",s:"I CAN'T drive."}], chat:[{q:"Can pig fly?",k:["no"],s:"Funny!",f:"No"},{q:"Can you read?",k:["yes"],s:"Good",f:"Yes"}], grammar:[{t:"Able",r:"Can + Verb",b:[{t:"I",c:"gb-sub"},{t:"Can",c:"gb-verb"},{t:"Read",c:"gb-obj"}]}], quiz:[{q:"Fish...",o:["Swim","Walk"],c:0}] },
  { title: "25. Yummy/Yuck ü§¢", slides:[{v:"üòã",t:"Yum",s:"I like it!"}, {v:"ü§¢",t:"Yuck",s:"I hate it!"}, {v:"ü•¶",t:"Veggie",s:"Good for you."}, {v:"üç¨",t:"Candy",s:"Sweet treat."}, {v:"üï∑Ô∏è",t:"Spider",s:"Don't eat!"}, {v:"‚ù§Ô∏è",t:"Love",s:"Very much."}], chat:[{q:"Like pizza?",k:["yes","yum"],s:"Me too",f:"Yes"},{q:"Eat spider?",k:["no","yuck"],s:"Eww",f:"No"}], grammar:[{t:"Like",r:"I + Like + Obj",b:[{t:"I",c:"gb-sub"},{t:"Like",c:"gb-verb"},{t:"Pizza",c:"gb-obj"}]}], quiz:[{q:"Chocolate is...",o:["Yum","Yuck"],c:0}] },
  { title: "26. -Ing Now üèÉ", slides:[{v:"üèÉ",t:"Running",s:"He is running."}, {v:"üö∂",t:"Walking",s:"She is walking."}, {v:"üìñ",t:"Reading",s:"I am reading."}, {v:"üó£Ô∏è",t:"Talking",s:"We are talking."}, {v:"üò¥",t:"Sleeping",s:"Cat is sleeping."}, {v:"üì∫",t:"Watching",s:"Watching TV."}], chat:[{q:"What are you doing?",k:["sitting","learning"],s:"Good student",f:"Learning"},{q:"Is cat running?",k:["no"],s:"It is sleeping",f:"No"}], grammar:[{t:"Cont",r:"Am/Is/Are + Ing",b:[{t:"She",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"Runn-ing",c:"gb-adj"}]}], quiz:[{q:"Now I am...",o:["Reading","Read"],c:0}] },
  { title: "27. Prepositions üì¶", slides:[{v:"üì¶",t:"In",s:"Inside box."}, {v:"‚¨ÜÔ∏è",t:"On",s:"Top of box."}, {v:"‚¨áÔ∏è",t:"Under",s:"Below box."}, {v:"‚ÜîÔ∏è",t:"Between",s:"In middle."}, {v:"üîô",t:"Behind",s:"At back."}, {v:"üîú",t:"Next to",s:"Beside box."}], chat:[{q:"Where is hat? On head?",k:["yes","on"],s:"Correct",f:"On head"},{q:"Fish in water?",k:["yes","in"],s:"Yes",f:"In water"}], grammar:[{t:"Loc",r:"It + is + Prep",b:[{t:"It",c:"gb-sub"},{t:"is",c:"gb-verb"},{t:"On table",c:"gb-obj"}]}], quiz:[{q:"Hat is ... head",o:["On","In"],c:0}] },
  { title: "28. Transport üöÇ", slides:[{v:"üöÇ",t:"Train",s:"Choo choo!"}, {v:"‚úàÔ∏è",t:"Plane",s:"Fly high."}, {v:"üöó",t:"Car",s:"Vroom vroom."}, {v:"üö≤",t:"Bike",s:"Ring ring."}, {v:"üö§",t:"Boat",s:"Float on water."}, {v:"üöÄ",t:"Rocket",s:"Go to space."}], chat:[{q:"Goes in water?",k:["boat","ship"],s:"Float",f:"Boat"},{q:"Has wings?",k:["plane"],s:"Fly",f:"Plane"}], grammar:[{t:"Go",r:"Go + by + Veh",b:[{t:"Go",c:"gb-verb"},{t:"by",c:"gb-prep"},{t:"Car",c:"gb-obj"}]}], quiz:[{q:"2 wheels?",o:["Bike","Car"],c:0}] },
  { title: "29. City Places üèôÔ∏è", slides:[{v:"üèôÔ∏è",t:"City",s:"Big buildings."}, {v:"üè•",t:"Hospital",s:"Doctors here."}, {v:"üöì",t:"Police",s:"Police station."}, {v:"üöí",t:"Fire",s:"Fire station."}, {v:"üõí",t:"Shop",s:"Buy food."}, {v:"üå≥",t:"Park",s:"Play outside."}], chat:[{q:"Sick? Go where?",k:["hospital","doctor"],s:"Get well",f:"Hospital"},{q:"Buy food?",k:["shop","market"],s:"Yum",f:"Shop"}], grammar:[{t:"Place",r:"Go + to + Place",b:[{t:"Go",c:"gb-verb"},{t:"to",c:"gb-prep"},{t:"Park",c:"gb-obj"}]}], quiz:[{q:"Swings are in...",o:["Park","Bank"],c:0}] },
  { title: "30. Traffic Rules üö¶", slides:[{v:"üö¶",t:"Light",s:"Traffic light."}, {v:"üî¥",t:"Red",s:"Stop!"}, {v:"üü°",t:"Yellow",s:"Wait."}, {v:"üü¢",t:"Green",s:"Go!"}, {v:"üö∂",t:"Cross",s:"Cross the road."}, {v:"üõë",t:"Sign",s:"Stop sign."}], chat:[{q:"Red light means?",k:["stop"],s:"Danger!",f:"Stop"},{q:"Green means?",k:["go"],s:"Safe",f:"Go"}], grammar:[{t:"Rule",r:"Imp + Now",b:[{t:"Stop!",c:"gb-verb"}]}], quiz:[{q:"Wait on...",o:["Yellow","Green"],c:0}] },
  { title: "31. Some / Any ü•£", slides:[{v:"ü•£",t:"Some",s:"I have some."}, {v:"ü´ó",t:"Any",s:"I don't have any."}, {v:"ü•õ",t:"Milk",s:"Some milk."}, {v:"üç™",t:"Cookie",s:"Any cookies?"}, {v:"üíß",t:"Water",s:"Some water."}, {v:"üö´",t:"None",s:"Empty."}], chat:[{q:"Want some water?",k:["yes","some"],s:"Here",f:"Yes"},{q:"Have money?",k:["no","any"],s:"Empty",f:"No"}], grammar:[{t:"Quant",r:"Have + Some/Any",b:[{t:"I",c:"gb-sub"},{t:"have",c:"gb-verb"},{t:"Some",c:"gb-adj"}]}], quiz:[{q:"Do you have ...?",o:["Any","Some"],c:0}] },
  { title: "32. Faster & Slower üèéÔ∏è", slides:[{v:"üèéÔ∏è",t:"Fast",s:"Race car."}, {v:"üêå",t:"Slow",s:"Snail."}, {v:"üêò",t:"Bigger",s:"Than a mouse."}, {v:"üêú",t:"Smaller",s:"Than a dog."}, {v:"ü¶í",t:"Taller",s:"Than me."}, {v:"üë¥",t:"Older",s:"Than baby."}], chat:[{q:"Turtle is?",k:["slow"],s:"Yes",f:"Slow"},{q:"Plane is?",k:["fast"],s:"Zoom",f:"Fast"}], grammar:[{t:"Comp",r:"Adj + er + Than",b:[{t:"A",c:"gb-sub"},{t:"is Faster",c:"gb-adj"},{t:"than B",c:"gb-obj"}]}], quiz:[{q:"Elephant is ... than ant",o:["Bigger","Smaller"],c:0}] },
  { title: "33. The Best ü•á", slides:[{v:"ü•á",t:"Best",s:"Number 1."}, {v:"ü•â",t:"Third",s:"Number 3."}, {v:"üêÜ",t:"Fastest",s:"Cheetah run."}, {v:"üêã",t:"Biggest",s:"Blue Whale."}, {v:"üêå",t:"Slowest",s:"Snail crawl."}, {v:"üèîÔ∏è",t:"Highest",s:"Everest."}], chat:[{q:"Who is number 1?",k:["me","i am"],s:"Yes you!",f:"Me"},{q:"Biggest animal?",k:["whale"],s:"Huge",f:"Whale"}], grammar:[{t:"Super",r:"The + Adj + est",b:[{t:"The",c:"gb-sub"},{t:"Fastest",c:"gb-adj"}]}], quiz:[{q:"Gold medal is...",o:["Best","Worst"],c:0}] },
  { title: "34. Past Tense: Was üîô", slides:[{v:"üë∂",t:"Was",s:"I was a baby."}, {v:"üë¥",t:"Am",s:"I am old now."}, {v:"üè´",t:"Were",s:"We were at school."}, {v:"üè†",t:"Home",s:"Was at home."}, {v:"üìÖ",t:"Yesterday",s:"Past day."}, {v:"üîô",t:"Past",s:"Before now."}], chat:[{q:"Were you a baby?",k:["yes","was"],s:"Cute",f:"Yes"},{q:"Yesterday hot?",k:["was","no"],s:"Ok",f:"It was..."}], grammar:[{t:"Past",r:"Was/Were",b:[{t:"I",c:"gb-sub"},{t:"Was",c:"gb-verb"},{t:"Small",c:"gb-adj"}]}], quiz:[{q:"I ... hungry",o:["Was","Were"],c:0}] },
  { title: "35. Played Yesterday üéÆ", slides:[{v:"üéÆ",t:"Played",s:"Game over."}, {v:"‚öΩ",t:"Kicked",s:"Goal!"}, {v:"üì∫",t:"Watched",s:"TV show."}, {v:"üç≥",t:"Cooked",s:"Made dinner."}, {v:"üßπ",t:"Cleaned",s:"Clean room."}, {v:"üìû",t:"Called",s:"Phone friend."}], chat:[{q:"Played games?",k:["yes","played"],s:"Fun",f:"Yes"},{q:"Watched TV?",k:["yes","watched"],s:"Show?",f:"Yes"}], grammar:[{t:"Reg",r:"Verb + ed",b:[{t:"I",c:"gb-sub"},{t:"Play-ed",c:"gb-verb"}]}], quiz:[{q:"Yesterday I...",o:["Played","Play"],c:0}] },
  { title: "36. Ate Pizza üçï", slides:[{v:"üçï",t:"Ate",s:"Yum yum."}, {v:"ü•§",t:"Drank",s:"Slurp."}, {v:"üèÉ",t:"Went",s:"Go -> Went."}, {v:"üèä",t:"Swam",s:"Swim -> Swam."}, {v:"üò¥",t:"Slept",s:"Sleep -> Slept."}, {v:"üëÄ",t:"Saw",s:"See -> Saw."}], chat:[{q:"Ate breakfast?",k:["ate","yes"],s:"Full",f:"Ate"},{q:"Went to school?",k:["went","yes"],s:"Good",f:"Went"}], grammar:[{t:"Irreg",r:"Special Word",b:[{t:"I",c:"gb-sub"},{t:"Ate",c:"gb-verb"},{t:"Food",c:"gb-obj"}]}], quiz:[{q:"Past of Eat",o:["Ate","Eated"],c:0}] },
  { title: "37. Future: Will üîÆ", slides:[{v:"üîÆ",t:"Will",s:"In future."}, {v:"üìÖ",t:"Tomorrow",s:"Next day."}, {v:"üåßÔ∏è",t:"Rain",s:"Will rain."}, {v:"üéÇ",t:"Age",s:"Will be 10."}, {v:"üöÄ",t:"Go",s:"Will go."}, {v:"ü§ñ",t:"Robot",s:"Will help."}], chat:[{q:"Tomorrow school?",k:["yes","will"],s:"Study",f:"Yes"},{q:"Will you play?",k:["yes","will"],s:"Fun",f:"Yes"}], grammar:[{t:"Fut",r:"Will + Verb",b:[{t:"I",c:"gb-sub"},{t:"Will",c:"gb-verb"},{t:"Go",c:"gb-obj"}]}], quiz:[{q:"Tomorrow I...",o:["Will","Did"],c:0}] },
  { title: "38. Plans üóìÔ∏è", slides:[{v:"üóìÔ∏è",t:"Plan",s:"Going to."}, {v:"üéí",t:"School",s:"Going to school."}, {v:"üõå",t:"Sleep",s:"Going to sleep."}, {v:"üçΩÔ∏è",t:"Eat",s:"Going to eat."}, {v:"‚úàÔ∏è",t:"Travel",s:"Going to fly."}, {v:"üëµ",t:"Visit",s:"Going to grandma."}], chat:[{q:"Going to sleep?",k:["yes","going"],s:"Night",f:"Yes"},{q:"Going to eat?",k:["yes"],s:"Hungry",f:"Yes"}], grammar:[{t:"Plan",r:"Going to + Verb",b:[{t:"I am",c:"gb-sub"},{t:"Going to",c:"gb-verb"},{t:"Eat",c:"gb-obj"}]}], quiz:[{q:"I am ... to run",o:["Going","Will"],c:0}] },
  { title: "39. Sick ü§í", slides:[{v:"ü§í",t:"Fever",s:"Hot head."}, {v:"ü§ß",t:"Cold",s:"Achoo!"}, {v:"ü§ï",t:"Ouch",s:"Pain."}, {v:"üíä",t:"Pill",s:"Take medicine."}, {v:"üõå",t:"Rest",s:"Stay in bed."}, {v:"ü©∫",t:"Doctor",s:"Help me."}], chat:[{q:"Feel sick?",k:["no","yes"],s:"Good/Oh no",f:"Yes/No"},{q:"Need doctor?",k:["yes"],s:"Call 911",f:"Yes"}], grammar:[{t:"Feel",r:"I + have + Sick",b:[{t:"I",c:"gb-sub"},{t:"Have",c:"gb-verb"},{t:"a Cold",c:"gb-obj"}]}], quiz:[{q:"Hot head?",o:["Fever","Cold"],c:0}] },
  { title: "40. Graduation üéìüéâ", slides:[{v:"üéì",t:"Graduation",s:"You finished!"}, {v:"üèÜ",t:"Winner",s:"You won!"}, {v:"üß†",t:"Smart",s:"Big brain!"}, {v:"üó£Ô∏è",t:"English",s:"You speak it!"}, {v:"ü•≥",t:"Party",s:"Let's celebrate!"}, {v:"üëã",t:"The End",s:"Good luck!"}], chat:[{q:"Are you happy?",k:["yes"],s:"I am proud!",f:"Yes"}], grammar:[{t:"Success",r:"You + Are + Adj",b:[{t:"You",c:"gb-sub"},{t:"Are",c:"gb-verb"},{t:"Smart üß†",c:"gb-adj"}]}], quiz:[{q:"You are a...",o:["Master","Baby"],c:0}] }
];

const app = {
  state: { l: 0, s: 0, q: 0, c: 0, mode: 'intro', score: 0, listening: false, lastMsg: "", done: [] },
  
  checkLogin() {
    const input = document.getElementById('passwordInput').value;
    const err = document.getElementById('loginError');
    if(btoa(input) === "MjI0NFRBWUxBTg==") {
      this.startApp();
    } else {
      err.style.display = 'block';
      err.classList.remove('anim-error');
      void err.offsetWidth; 
      err.classList.add('anim-error');
    }
  },

  startApp() {
    document.getElementById('startOverlay').style.display = 'none';
    document.getElementById('mainContent').style.filter = 'none';
    this.renderSidebar();
    this.renderRobot('happy');
    this.load();
    this.speak("Welcome to Robo Kanka Academy! Let's start.");
    setTimeout(() => this.startLesson(this.state.l), 1000);
  },

  startLesson(idx) {
    this.state.l = idx; this.state.s = 0; this.state.q = 0; this.state.c = 0; this.state.mode = 'slide';
    
    document.getElementById('sidebar').classList.remove('show');
    document.getElementById('backdrop').classList.remove('show');
    
    this.renderSidebar();
    this.renderSlide();
    document.getElementById('chatBox').innerHTML = ''; 
    document.getElementById('statusBadge').innerText = "Topic: " + LESSONS[idx].title;
    this.updateProgressBar();
  },

  updateProgressBar() {
    const lesson = LESSONS[this.state.l];
    let pct = 0;
    const totalSlides = lesson.slides.length;
    const totalChat = lesson.chat.length;
    const totalQuiz = lesson.quiz.length;
    
    if(this.state.mode === 'slide') pct = (this.state.s / totalSlides) * 50;
    else if(this.state.mode === 'chat') pct = 50 + (this.state.c / totalChat) * 20;
    else if(this.state.mode === 'grammar') pct = 75;
    else if(this.state.mode === 'quiz') pct = 80 + (this.state.q / totalQuiz) * 20;
    
    document.getElementById('lessonProgressBar').style.width = `${pct}%`;
  },

  renderSidebar() {
    const list = document.getElementById('lessonList');
    list.innerHTML = LESSONS.map((les, i) => `
      <div class="lesson-item ${i === this.state.l ? 'active' : ''}" onclick="app.startLesson(${i})">
        <div class="lesson-badge">${this.state.done.includes(i) ? '‚úÖ' : 'üîí'}</div>
        <div class="fw-bold text-truncate">${les.title}</div>
      </div>
    `).join('');
  },

  renderSlide() {
    const slide = LESSONS[this.state.l].slides[this.state.s];
    document.getElementById('boardPanel').innerHTML = `
      <div class="d-flex flex-column justify-content-center align-items-center h-100 text-center p-3" style="background:${slide.c || '#fff'}">
        <div class="slide-visual ${slide.a || ''}">${slide.v}</div>
        <div class="slide-text">
          <div>${slide.t}</div>
          <small class="slide-story">${slide.s}</small>
        </div>
        <div class="mt-4 d-flex gap-3 w-100 px-3">
          ${this.state.s > 0 ? `<button class="btn btn-light rounded-circle shadow" onclick="app.navSlide(-1)">‚¨ÖÔ∏è</button>` : ''}
          <button class="btn btn-primary flex-grow-1 rounded-pill shadow fs-4 fw-bold animate-pulse" onclick="app.navSlide(1)">
            ${this.state.s < LESSONS[this.state.l].slides.length-1 ? 'NEXT ‚û°Ô∏è' : 'CHAT üí¨'}
          </button>
        </div>
      </div>
    `;
    this.speak(slide.s);
    this.updateProgressBar();
  },

  navSlide(dir) {
    const max = LESSONS[this.state.l].slides.length - 1;
    if (dir === 1 && this.state.s < max) { this.state.s++; this.renderSlide(); }
    else if (dir === -1 && this.state.s > 0) { this.state.s--; this.renderSlide(); }
    else if (dir === 1 && this.state.s === max) { this.startChat(); }
  },

  startChat() {
    this.state.mode = 'chat';
    this.updateProgressBar();
    document.getElementById('boardPanel').innerHTML = `
      <div class="d-flex flex-column justify-content-center align-items-center h-100 bg-white p-4 text-center">
        <div class="display-1 mb-3 anim-float">üí¨</div>
        <h2 class="fw-bold text-primary">Let's Talk!</h2>
        <p class="text-muted fs-5">I will ask you a question.</p>
        <div class="badge bg-warning text-dark fs-6 mt-3">Press Microphone üé§</div>
      </div>
    `;
    this.chatStep();
  },

  chatStep() {
    const q = LESSONS[this.state.l].chat[this.state.c];
    this.addChat('ai', q.q);
    this.speak(q.q);
  },

  handleSpeech(txt) {
    if (this.state.mode !== 'chat') return;
    this.addChat('user', txt);
    const step = LESSONS[this.state.l].chat[this.state.c];
    
    const match = step.k.some(k => txt.toLowerCase().includes(k));
    
    if (match || txt.length > 2) { 
      this.renderRobot('happy');
      this.speak(step.s);
      setTimeout(() => {
        this.state.c++;
        if (this.state.c < LESSONS[this.state.l].chat.length) {
            this.chatStep(); 
            this.updateProgressBar();
        }
        else this.startGrammar();
      }, 2500);
    } else {
      this.renderRobot('surprised');
      this.speak("Try again! " + step.f);
    }
  },

  startGrammar() {
    this.state.mode = 'grammar';
    this.updateProgressBar();
    const g = LESSONS[this.state.l].grammar;
    let html = `<div class="h-100 overflow-auto p-4 bg-white text-center"><h2 class="fw-bold text-primary mb-3">Grammar Lab üß™</h2>`;
    
    if(g && g.length > 0) {
      g.forEach(rule => {
        let blocks = rule.b.map(x => `<span class="g-block ${x.c}">${x.t}</span>`).join('');
        html += `<div class="grammar-box"><div class="fw-bold text-secondary mb-1">${rule.t}</div><div class="small text-muted mb-2">${rule.r}</div><div>${blocks}</div></div>`;
      });
    } else {
        html += `<div class="p-4 text-muted">Just practice!</div>`;
    }
    
    html += `<button class="btn btn-success btn-lg rounded-pill mt-4 shadow w-100 anim-pulse" onclick="app.startQuiz()">START QUIZ üß†</button></div>`;
    document.getElementById('boardPanel').innerHTML = html;
    this.speak("Look at the magic sentence blocks! Then let's do a quiz.");
  },

  startQuiz() {
    this.state.mode = 'quiz';
    this.state.q = 0;
    this.updateProgressBar();
    this.renderQuiz();
  },

  renderQuiz() {
    const q = LESSONS[this.state.l].quiz[this.state.q];
    document.getElementById('boardPanel').innerHTML = `
      <div class="d-flex flex-column justify-content-center h-100 p-4 bg-white text-center">
        <div class="badge bg-info mb-3 fs-6">Question ${this.state.q+1}</div>
        <h3 class="fw-bold text-dark mb-4">${q.q}</h3>
        <div class="d-grid gap-3">
          ${q.o.map((opt, i) => `<button class="btn btn-outline-primary p-3 fs-5 rounded-pill fw-bold text-start" onclick="app.ans(${i}, this)">${opt}</button>`).join('')}
        </div>
      </div>
    `;
    this.speak(q.q);
  },

  ans(i, btn) {
    const q = LESSONS[this.state.l].quiz[this.state.q];
    const btns = document.querySelectorAll('#boardPanel button');
    btns.forEach(b => b.disabled = true);
    
    if (i === q.c) {
      btn.className = "btn btn-success p-3 fs-5 rounded-pill fw-bold text-start text-white shadow";
      this.state.score += 10;
      this.updateScore();
      this.renderRobot('happy');
      this.speak("Correct! You are a star! üåü");
      setTimeout(() => {
        if (this.state.q < LESSONS[this.state.l].quiz.length - 1) {
          this.state.q++;
          this.updateProgressBar();
          this.renderQuiz();
        } else {
          this.finish();
        }
      }, 2000);
    } else {
      btn.className = "btn btn-danger p-3 fs-5 rounded-pill fw-bold text-start text-white";
      this.renderRobot('surprised');
      this.speak("Oops! Try again.");
      setTimeout(() => {
        if (this.state.q < LESSONS[this.state.l].quiz.length - 1) {
          this.state.q++;
          this.updateProgressBar();
          this.renderQuiz();
        } else {
          this.finish();
        }
      }, 2000);
    }
  },

  finish() {
    document.getElementById('lessonProgressBar').style.width = "100%";
    if(!this.state.done.includes(this.state.l)) this.state.done.push(this.state.l);
    this.save();
    this.renderSidebar();
    document.getElementById('boardPanel').innerHTML = `
      <div class="d-flex flex-column justify-content-center align-items-center h-100 bg-success bg-opacity-10 text-center">
        <div class="display-1 anim-pop">üèÜ</div>
        <h2 class="fw-bold text-success mt-3">Lesson Complete!</h2>
        <p class="fs-4">You earned points! ‚≠ê</p>
        <button class="btn btn-success btn-lg rounded-pill mt-4 shadow anim-pulse" onclick="app.startLesson(${Math.min(this.state.l+1, LESSONS.length-1)})">Next Adventure ‚û°Ô∏è</button>
      </div>
    `;
    this.speak("Congratulations! Lesson Complete!");
  },

  speak(txt) {
    this.state.lastMsg = txt;
    this.addChat('ai', txt);
    window.speechSynthesis.cancel();
    
    const cleanTxt = txt.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
    
    const u = new SpeechSynthesisUtterance(cleanTxt);
    u.lang = 'en-US'; 
    u.rate = 0.9; 
    u.pitch = 1.2; 
    
    const voices = window.speechSynthesis.getVoices();
    let v = voices.find(voice => voice.name.includes("Google US English")); 
    if(!v) v = voices.find(voice => voice.name.includes("Microsoft Zira"));
    if(!v) v = voices.find(voice => voice.name.includes("Samantha"));
    if(!v) v = voices.find(voice => voice.lang === 'en-US');
    if(v) u.voice = v;

    u.onstart = () => this.renderRobot('talking');
    u.onend = () => this.renderRobot('happy');
    window.speechSynthesis.speak(u);
  },

  toggleMic() {
    if (!this.state.listening) {
      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.recognition.lang = 'en-US';
        this.recognition.onstart = () => {
          this.state.listening = true;
          document.getElementById('micBtn').classList.add('mic-active');
          this.renderRobot('listening');
        };
        this.recognition.onend = () => {
          this.state.listening = false;
          document.getElementById('micBtn').classList.remove('mic-active');
          this.renderRobot('happy');
        };
        this.recognition.onresult = (e) => this.handleSpeech(e.results[0][0].transcript);
        this.recognition.start();
      } catch(e) { alert("Mic error or not supported."); }
    } else {
      this.recognition.stop();
    }
  },

  addChat(sender, txt) {
    const d = document.createElement('div');
    d.className = `chat-bubble ${sender === 'user' ? 'chat-user' : 'chat-ai'}`;
    d.innerHTML = txt;
    const box = document.getElementById('chatBox');
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
  },

  renderRobot(state) {
    let eyes, mouth;
    const color = "#334155";
    if(state === 'happy') { eyes=`<path d="M35 45 Q40 35 45 45" stroke="${color}" stroke-width="4" fill="none"/><path d="M55 45 Q60 35 65 45" stroke="${color}" stroke-width="4" fill="none"/>`; mouth=`<path d="M35 65 Q50 80 65 65" stroke="${color}" stroke-width="4" fill="none" stroke-linecap="round"/>`; }
    else if(state === 'talking') { eyes=`<circle cx="40" cy="45" r="5" fill="${color}"/><circle cx="60" cy="45" r="5" fill="${color}"/>`; mouth=`<rect x="40" y="65" width="20" height="10" rx="5" fill="${color}" class="anim-pulse"/>`; }
    else if(state === 'listening') { eyes=`<circle cx="40" cy="45" r="5" fill="${color}"/><circle cx="60" cy="45" r="5" fill="${color}"/>`; mouth=`<circle cx="50" cy="70" r="5" fill="#0ea5e9" class="anim-pulse"/>`; }
    else { eyes=`<circle cx="40" cy="40" r="6" fill="${color}"/><circle cx="60" cy="40" r="6" fill="${color}"/>`; mouth=`<circle cx="50" cy="70" r="8" fill="none" stroke="${color}" stroke-width="3"/>`; }
    
    document.getElementById('robotFace').innerHTML = `
      <svg viewBox="0 0 100 100" class="w-100 h-100 drop-shadow">
        <line x1="50" y1="15" x2="50" y2="0" stroke="#bae6fd" stroke-width="4"/><circle cx="50" cy="0" r="6" fill="#f43f5e" class="anim-pulse"/>
        <rect x="15" y="15" width="70" height="75" rx="20" fill="#fff" stroke="#bae6fd" stroke-width="4"/>
        <rect x="25" y="30" width="50" height="50" rx="10" fill="#f8fafc" stroke="#e2e8f0" stroke-width="2"/>
        <circle cx="20" cy="60" r="4" fill="#fda4af" opacity="0.6"/><circle cx="80" cy="60" r="4" fill="#fda4af" opacity="0.6"/>
        ${eyes}${mouth}
      </svg>`;
  },

  hint() { 
    if(this.state.mode === 'chat') this.speak("Hint: " + LESSONS[this.state.l].chat[this.state.c].f); 
    else this.speak("Listen and look at the screen! üëÄ");
  },
  
  repeat() { this.speak(this.state.lastMsg); },
  toggleSidebar() { 
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    sidebar.classList.toggle('show');
    backdrop.classList.toggle('show');
  },
  
  save() { localStorage.setItem('roboEmoji', JSON.stringify({s:this.state.score, d:this.state.done})); },
  load() { 
    const d = JSON.parse(localStorage.getItem('roboEmoji')); 
    if(d) { this.state.score=d.s; this.state.done=d.d; this.updateScore(); }
  },
  updateScore() { document.getElementById('mobileScore').innerText = `‚≠ê ${this.state.score}`; },
  resetProgress() { 
    if(confirm("Reset?")) { localStorage.removeItem('roboEmoji'); location.reload(); } 
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>